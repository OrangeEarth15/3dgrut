// SPDX-FileCopyrightText: Copyright (c) 2025 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
// SPDX-License-Identifier: Apache-2.0
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
// http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

/**
 * é«˜æ–¯ç²’å­æ¨¡å‹ (Gaussian Particle Model)
 * 
 * æœ¬æ¨¡å—å®ç°äº†åŸºäºé«˜æ–¯å‡½æ•°çš„ç²’å­ç³»ç»Ÿï¼Œç”¨äºé«˜è´¨é‡çš„ä½“ç§¯æ¸²æŸ“ã€‚
 * é«˜æ–¯ç²’å­é€šè¿‡ä¸‰ç»´é«˜æ–¯çƒæ¥è¡¨ç¤ºï¼Œæ”¯æŒæ—‹è½¬ã€ç¼©æ”¾å’Œå¹³ç§»å˜æ¢ã€‚
 * 
 * ä¸»è¦åŠŸèƒ½ï¼š
 * - é«˜æ–¯ç²’å­å‚æ•°ç®¡ç†ï¼ˆä½ç½®ã€æ—‹è½¬ã€ç¼©æ”¾ã€å¯†åº¦ï¼‰
 * - å°„çº¿-é«˜æ–¯çƒç›¸äº¤æµ‹è¯•
 * - å¤šç§æ ¸å‡½æ•°æ”¯æŒï¼ˆä»çº¿æ€§åˆ°é«˜é˜¶å¤šé¡¹å¼ï¼‰
 * - è‡ªåŠ¨å¾®åˆ†å’Œæ¢¯åº¦è®¡ç®—
 * - Surfelæ¨¡å¼ï¼ˆäºŒç»´é¢ç‰‡ï¼‰æ”¯æŒ
 */

// å¯¼å…¥å‡ ä½•å˜æ¢æ¨¡å—
#include <3dgut/kernels/slang/common/transforms.slang>

namespace gaussianParticle {

/**
 * åŸå§‹ç²’å­å‚æ•°ç»“æ„ - ç´§å‡‘å­˜å‚¨æ ¼å¼
 * 
 * å­˜å‚¨é«˜æ–¯ç²’å­çš„åŸå§‹å‚æ•°ï¼Œç”¨äºé«˜æ•ˆçš„å†…å­˜å­˜å‚¨å’Œä¼ è¾“ã€‚
 * å®ç°IDifferentiableæ¥å£ï¼Œæ”¯æŒè‡ªåŠ¨å¾®åˆ†è®¡ç®—ã€‚
 * 
 * æ³¨æ„ï¼šå››å…ƒæ•°ä½¿ç”¨(w,x,y,z)é¡ºåºï¼Œå…¶ä¸­wæ˜¯å®éƒ¨ã€‚
 */
 // IDifferentiableå£°æ˜è¿™ä¸ªç»“æ„ä½“æ”¯æŒè‡ªåŠ¨å¾®åˆ†
struct RawParameters : IDifferentiable { // 3 + 1 + 4 + 3 + 1 = 12
    float3 position;    // ç²’å­3Dä½ç½®åæ ‡ï¼ˆä¸–ç•Œç©ºé—´ï¼‰
    float density;      // ç²’å­å¯†åº¦ï¼ˆä¸é€æ˜åº¦ï¼Œæ§åˆ¶é€å°„ç‡ï¼‰
    float4 quaternion;  // ç²’å­æ—‹è½¬å››å…ƒæ•° (w,x,y,z)ï¼Œå•ä½å››å…ƒæ•°
    float3 scale;       // ç²’å­3Dç¼©æ”¾å› å­ï¼ˆæ²¿ä¸‰ä¸ªä¸»è½´çš„åŠå¾„ï¼‰
    float padding;      // å†…å­˜å¯¹é½å¡«å……ï¼ˆGPUå†…å­˜å¯¹é½ä¼˜åŒ–ï¼‰
};

/**
 * åŸå§‹å‚æ•°ç¼“å†²åŒºç®¡ç†ç»“æ„
 * 
 * ç®¡ç†é«˜æ–¯ç²’å­å‚æ•°çš„å­˜å‚¨å’Œæ¢¯åº¦æ›´æ–°ã€‚æ”¯æŒä¸¤ç§æ¢¯åº¦æ›´æ–°æ¨¡å¼ï¼š
 * 1. æ’ä»–æ€§æ¨¡å¼ï¼šå•çº¿ç¨‹æˆ–æ— ç«äº‰ç¯å¢ƒï¼Œç›´æ¥æ›´æ–°ï¼ˆæ€§èƒ½æ›´å¥½ï¼‰
 * 2. å¹¶å‘æ¨¡å¼ï¼šå¤šçº¿ç¨‹ç¯å¢ƒï¼Œä½¿ç”¨åŸå­æ“ä½œï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰
 */
struct RawParametersBuffer {
    const RawParameters* _dataPtr;        // æŒ‡å‘å‚æ•°æ•°æ®çš„å¸¸é‡æŒ‡é’ˆï¼ˆåªè¯»ï¼‰
    RawParameters *_gradPtr;              // æŒ‡å‘æ¢¯åº¦æ•°æ®çš„æŒ‡é’ˆï¼ˆå¯å†™ï¼Œç”¨äºæ¢¯åº¦ç§¯ç´¯ï¼‰
    bool exclusiveGradient;               // æ˜¯å¦ä½¿ç”¨æ’ä»–æ€§æ¢¯åº¦æ›´æ–°ï¼ˆé¿å…åŸå­æ“ä½œï¼‰
};

/**
 * é€šç”¨å‚æ•°åŒ…è£…ç»“æ„
 */
struct CommonParameters {
    RawParametersBuffer parametersBuffer;  // å‚æ•°ç¼“å†²åŒºç®¡ç†å™¨
};

/**
 * ä»ç¼“å†²åŒºè·å–åŸå§‹ç²’å­å‚æ•°çš„å‰å‘å‡½æ•°
 *
 * æ ¹æ®ç²’å­ç´¢å¼•ä»å…¨å±€ç¼“å†²åŒºä¸­è·å–åŸå§‹å‚æ•°ã€‚
 * æ”¯æŒSurfelæ¨¡å¼ï¼Œåœ¨è¯¥æ¨¡å¼ä¸‹å°†Zè½´ç¼©æ”¾è®¾ä¸ºæå°å€¼ä»¥å®ç°2Dé¢ç‰‡æ•ˆæœã€‚
 *
 * @param particleIdx ç²’å­ç´¢å¼•ï¼ˆä¸å‚ä¸å¾®åˆ†è®¡ç®—ï¼‰
 * @param parametersBuffer å‚æ•°ç¼“å†²åŒºï¼ˆä¸å‚ä¸å¾®åˆ†è®¡ç®—ï¼‰
 * @return è·å–çš„åŸå§‹å‚æ•°ï¼ˆå¯èƒ½ç»Surfelæ¨¡å¼ä¿®æ”¹ï¼‰
 */
 //[BackwardDifferentiable] å«ä¹‰ï¼šå£°æ˜æ­¤å‡½æ•°æ”¯æŒåå‘è‡ªåŠ¨å¾®åˆ†
 // ä½œç”¨ï¼šSlang ç¼–è¯‘å™¨ä¼šè‡ªåŠ¨ç”Ÿæˆå¯¹åº”çš„æ¢¯åº¦è®¡ç®—ä»£ç 
 // å®é™…æ•ˆæœï¼šè®­ç»ƒæ—¶å¯ä»¥è‡ªåŠ¨è®¡ç®—å‚æ•°æ¢¯åº¦ï¼Œæ— éœ€æ‰‹å†™æ±‚å¯¼
[BackwardDifferentiable][ForceInline] RawParameters fetchParametersFromBuffer(
    no_diff uint32_t particleIdx,              // ç²’å­ç´¢å¼•ï¼ˆä¸å‚ä¸å¾®åˆ†ï¼‰
    no_diff RawParametersBuffer parametersBuffer) {  // å‚æ•°ç¼“å†²åŒºï¼ˆä¸å‚ä¸å¾®åˆ†ï¼‰
    
    // ä»å…¨å±€ç¼“å†²åŒºè¯»å–æŒ‡å®šç²’å­çš„å‚æ•°
    RawParameters rawParameters = parametersBuffer._dataPtr[particleIdx];
    
    // Surfelæ¨¡å¼ï¼šå°†ä¸‰ç»´é«˜æ–¯çƒå‹ç¼©ä¸ºäºŒç»´é¢ç‰‡
    if (Surfel) {
        rawParameters.scale.z = 1e-06f;  // å°†Zè½´åšåº¦è®¾ä¸ºæ¥è¿‘0ï¼ˆæè–„é¢ç‰‡ï¼‰
    }
    return rawParameters;
}

/**
 * fetchParametersFromBufferå‡½æ•°çš„åå‘ä¼ æ’­ç‰ˆæœ¬
 *
 * å®ç°å‚æ•°è·å–çš„æ¢¯åº¦åå‘ä¼ æ’­ï¼Œå°†ä»åç»­è®¡ç®—ä¼ å›çš„æ¢¯åº¦ç´¯åŠ åˆ°å…¨å±€æ¢¯åº¦ç¼“å†²åŒºã€‚
 * å¯¹Surfelæ¨¡å¼åšç‰¹æ®Šå¤„ç†ï¼Œä¸æ›´æ–°Zè½´ç¼©æ”¾æ¢¯åº¦ã€‚
 *
 * @param particleIdx ç²’å­ç´¢å¼•
 * @param parametersBuffer å‚æ•°ç¼“å†²åŒº
 * @param rawParameters ä»åç»­è®¡ç®—ä¼ å›çš„æ¢¯åº¦
 */
// æ¨¡å¼1:è‡ªåŠ¨ç”Ÿæˆæ¢¯åº¦ï¼ˆåªéœ€ [BackwardDifferentiable]ï¼‰
// æ¨¡å¼2:è‡ªå®šä¹‰æ¢¯åº¦é€»è¾‘ï¼ˆéœ€è¦æˆå¯¹å‡ºç°[BackwardDerivativeOf(xxx)]å’Œ[BackwardDifferentiable]ï¼‰

[BackwardDerivativeOf(fetchParametersFromBuffer)][ForceInline] void fetchParametersFromBufferBwd(
    no_diff uint32_t particleIdx,              // ç²’å­ç´¢å¼•
    no_diff RawParametersBuffer parametersBuffer,  // å‚æ•°ç¼“å†²åŒº
    RawParameters rawParameters) {              // æ¢¯åº¦è¾“å…¥ï¼ˆä»åç»­è®¡ç®—ä¼ å›ï¼‰
    
    // æ ¹æ®æ¢¯åº¦æ›´æ–°æ¨¡å¼é€‰æ‹©ä¸åŒçš„ç´¯åŠ ç­–ç•¥
    if (parametersBuffer.exclusiveGradient) {
        // æ’ä»–æ€§æ¨¡å¼ï¼šç›´æ¥ç´¯åŠ ï¼Œæ— éœ€åŸå­æ“ä½œï¼ˆå•çº¿ç¨‹æˆ–æ— ç«äº‰ï¼‰
        parametersBuffer._gradPtr[particleIdx].density += rawParameters.density;
        parametersBuffer._gradPtr[particleIdx].position += rawParameters.position;
        parametersBuffer._gradPtr[particleIdx].quaternion += rawParameters.quaternion;
        if (!Surfel) {
            // 3Dæ¨¡å¼ï¼šæ›´æ–°æ‰€æœ‰ç¼©æ”¾åˆ†é‡
            parametersBuffer._gradPtr[particleIdx].scale += rawParameters.scale;
        } else {
            // Surfelæ¨¡å¼ï¼šåªæ›´æ–°XYç¼©æ”¾ï¼Œå¿½ç•¥Zè½´ï¼ˆä¿æŒé¢ç‰‡ç‰¹æ€§ï¼‰
            parametersBuffer._gradPtr[particleIdx].scale.xy += rawParameters.scale.xy;
        }
    } else {
        // éæ’ä»–æ€§æ¨¡å¼ï¼šä½¿ç”¨åŸå­æ“ä½œé˜²æ­¢ç«äº‰ï¼ˆå¤šçº¿ç¨‹å¹¶å‘å®‰å…¨ï¼‰
        InterlockedAdd(parametersBuffer._gradPtr[particleIdx].density, rawParameters.density);
        InterlockedAdd(parametersBuffer._gradPtr[particleIdx].position.x, rawParameters.position.x);
        InterlockedAdd(parametersBuffer._gradPtr[particleIdx].position.y, rawParameters.position.y);
        InterlockedAdd(parametersBuffer._gradPtr[particleIdx].position.z, rawParameters.position.z);
        InterlockedAdd(parametersBuffer._gradPtr[particleIdx].quaternion.x, rawParameters.quaternion.x);
        InterlockedAdd(parametersBuffer._gradPtr[particleIdx].quaternion.y, rawParameters.quaternion.y);
        InterlockedAdd(parametersBuffer._gradPtr[particleIdx].quaternion.z, rawParameters.quaternion.z);
        InterlockedAdd(parametersBuffer._gradPtr[particleIdx].quaternion.w, rawParameters.quaternion.w);
        InterlockedAdd(parametersBuffer._gradPtr[particleIdx].scale.x, rawParameters.scale.x);
        InterlockedAdd(parametersBuffer._gradPtr[particleIdx].scale.y, rawParameters.scale.y);
        if (!Surfel) {
            InterlockedAdd(parametersBuffer._gradPtr[particleIdx].scale.z, rawParameters.scale.z);
        }
    }
}

/**
 * è®¡ç®—ä¼˜åŒ–çš„ç²’å­å‚æ•°ç»“æ„ - å±•å¼€æ ¼å¼ä¾¿äºè®¡ç®—
 * 
 * å°†åŸå§‹å‚æ•°è½¬æ¢ä¸ºä¼˜åŒ–çš„è®¡ç®—æ ¼å¼ï¼Œæé«˜è®¡ç®—æ•ˆç‡ã€‚
 * ä¸»è¦ä¼˜åŒ–ï¼šå°†å››å…ƒæ•°è½¬æ¢ä¸ºæ—‹è½¬çŸ©é˜µè½¬ç½®ï¼Œå‡å°‘é‡å¤è®¡ç®—ã€‚
 */
struct Parameters : IDifferentiable {
    float3 position;      // ç²’å­ä½ç½®ï¼ˆä¸–ç•Œç©ºé—´åæ ‡ï¼‰
    float3 scale;         // ç²’å­ç¼©æ”¾ï¼ˆä¸‰ä¸ªä¸»è½´çš„åŠå¾„ï¼‰
    float3x3 rotationT;   // æ—‹è½¬çŸ©é˜µè½¬ç½®ï¼ˆä¼˜åŒ–åçš„æ ¼å¼ï¼Œç”¨äºå¿«é€Ÿå˜æ¢ï¼‰
    float density;        // ç²’å­å¯†åº¦ï¼ˆæ§åˆ¶ä¸é€æ˜åº¦ï¼‰
};

/**
 * è·å–è®¡ç®—ä¼˜åŒ–çš„ç²’å­å‚æ•°ï¼ˆå°†å››å…ƒæ•°è½¬æ¢ä¸ºæ—‹è½¬çŸ©é˜µï¼‰
 * 
 * å°†åŸå§‹çš„ç´§å‡‘å‚æ•°æ ¼å¼è½¬æ¢ä¸ºè®¡ç®—ä¼˜åŒ–çš„æ ¼å¼ã€‚
 * ä¸»è¦ä¼˜åŒ–ï¼šå°†å››å…ƒæ•°é¢„è®¡ç®—ä¸ºæ—‹è½¬çŸ©é˜µè½¬ç½®ï¼Œé¿å…åœ¨æ¸²æŸ“å¾ªç¯ä¸­é‡å¤è®¡ç®—ã€‚
 * 
 * @param particleIdx ç²’å­ç´¢å¼•
 * @param parametersBuffer å‚æ•°ç¼“å†²åŒº
 * @return ä¼˜åŒ–åçš„å‚æ•°ç»“æ„
 */
[BackwardDifferentiable][ForceInline] Parameters fetchParameters(
    no_diff uint32_t particleIdx,                    // ç²’å­ç´¢å¼•
    no_diff RawParametersBuffer parametersBuffer) {  // å‚æ•°ç¼“å†²åŒº
    
    // å…ˆè·å–åŸå§‹å‚æ•°
    const RawParameters rawParameters = fetchParametersFromBuffer(particleIdx, parametersBuffer);
    
    // è¿”å›ä¼˜åŒ–çš„è®¡ç®—æ ¼å¼ï¼Œå°†å››å…ƒæ•°è½¬æ¢ä¸ºæ—‹è½¬çŸ©é˜µè½¬ç½®
    return {
        rawParameters.position,                                           // ç›´æ¥å¤åˆ¶ä½ç½®
        rawParameters.scale,                                             // ç›´æ¥å¤åˆ¶ç¼©æ”¾
        transforms.rotationMatrixTranspose(rawParameters.quaternion),    // å››å…ƒæ•°â†’æ—‹è½¬çŸ©é˜µè½¬ç½®
        rawParameters.density                                            // ç›´æ¥å¤åˆ¶å¯†åº¦
    };
}
/**
 * å°†ä¸–ç•Œç©ºé—´å°„çº¿è½¬æ¢ä¸ºç²’å­å±€éƒ¨ç©ºé—´çš„æ ‡å‡†åŒ–å°„çº¿
 * 
 * è¿™æ˜¯é«˜æ–¯ç›¸äº¤æµ‹è¯•çš„æ ¸å¿ƒæ­¥éª¤ï¼šå°†ä»»æ„å°„çº¿è½¬æ¢åˆ°å•ä½çƒç©ºé—´ï¼Œ
 * è¿™æ ·å¯ä»¥ç”¨ç»Ÿä¸€çš„ç®—æ³•å¤„ç†ä¸åŒå½¢çŠ¶å’Œå¤§å°çš„é«˜æ–¯çƒã€‚
 * 
 * å˜æ¢æ­¥éª¤ï¼š
 * 1. å¹³ç§»ï¼šå°†å°„çº¿ç§»åŠ¨åˆ°ä»¥ç²’å­ä¸ºåŸç‚¹çš„åæ ‡ç³»
 * 2. æ—‹è½¬ï¼šåº”ç”¨ç²’å­çš„æ—‹è½¬çŸ©é˜µè½¬ç½®
 * 3. ç¼©æ”¾ï¼šæŒ‰ç¼©æ”¾å› å­çš„å€’æ•°ç¼©æ”¾
 * 
 * @param rayOrigin ä¸–ç•Œç©ºé—´å°„çº¿èµ·ç‚¹
 * @param rayDirection ä¸–ç•Œç©ºé—´å°„çº¿æ–¹å‘ï¼ˆå•ä½å‘é‡ï¼‰
 * @param parameters ç²’å­å‚æ•°
 * @param particleRayOrigin è¾“å‡ºï¼šæ ‡å‡†åŒ–ç©ºé—´å°„çº¿èµ·ç‚¹
 * @param particleRayDirection è¾“å‡ºï¼šæ ‡å‡†åŒ–ç©ºé—´å°„çº¿æ–¹å‘å•ä½å‘é‡
 */
[BackwardDifferentiable][ForceInline] void cannonicalRay(
    in float3 rayOrigin,
    in float3 rayDirection,
    in Parameters parameters,
    out float3 particleRayOrigin,
    out float3 particleRayDirection, ) {
    
    // 1. è®¡ç®—ç¼©æ”¾å› å­çš„å€’æ•°ï¼ˆç”¨äºå°†é«˜æ–¯æ¤­çƒæ ‡å‡†åŒ–ä¸ºå•ä½çƒï¼‰
    const float3 giscl  = float3(1.0f) / parameters.scale;
    
    // 2. å¹³ç§»ï¼šå°„çº¿èµ·ç‚¹ç›¸å¯¹äºç²’å­ä¸­å¿ƒçš„ä½ç½®
    const float3 gposc  = (rayOrigin - parameters.position);
    
    // 3. æ—‹è½¬ï¼šåº”ç”¨æ—‹è½¬çŸ©é˜µè½¬ç½®å°†å°„çº¿è½¬æ¢åˆ°ç²’å­çš„å±€éƒ¨åæ ‡ç³»
    const float3 gposcr = mul(parameters.rotationT, gposc);
    
    // 4. ç¼©æ”¾ï¼šæŒ‰æ¯”ä¾‹ç¼©æ”¾ï¼Œå°†é«˜æ–¯æ¤­çƒæ ‡å‡†åŒ–ä¸ºå•ä½çƒ
    particleRayOrigin   = giscl * gposcr;

    // å¯¹å°„çº¿æ–¹å‘è¿›è¡Œç›¸åŒçš„æ—‹è½¬å’Œç¼©æ”¾å˜æ¢
    const float3 rayDirR = mul(parameters.rotationT, rayDirection);
    const float3 grdu    = giscl * rayDirR;
    particleRayDirection = normalize(grdu);  // é‡æ–°å•ä½åŒ–ä¿è¯æ–¹å‘å‘é‡çš„æ­£ç¡®æ€§
}

/**
 * è®¡ç®—æ ‡å‡†åŒ–ç©ºé—´ä¸­å°„çº¿åˆ°åŸç‚¹çš„æœ€å°å¹³æ–¹è·ç¦»
 * 
 * åœ¨æ ‡å‡†åŒ–çš„å•ä½çƒç©ºé—´ä¸­ï¼Œè®¡ç®—å°„çº¿åˆ°çƒå¿ƒï¼ˆåŸç‚¹ï¼‰çš„æœ€å°è·ç¦»çš„å¹³æ–¹ã€‚
 * è¿™ä¸ªè·ç¦»ç”¨äºåˆ¤æ–­å°„çº¿æ˜¯å¦ä¸é«˜æ–¯æ¤­çƒç›¸äº¤ã€‚
 * 
 * ç®—æ³•ï¼šä½¿ç”¨å‘é‡å‰ç§¯è®¡ç®—ç‚¹åˆ°ç›´çº¿çš„è·ç¦»
 * |cross(direction, origin)| = |origin| * sin(Î¸)
 * å…¶ä¸­Î¸æ˜¯originå‘é‡ä¸directionå‘é‡çš„å¤¹è§’
 * 
 * @param canonicalRayOrigin æ ‡å‡†åŒ–ç©ºé—´ä¸­çš„å°„çº¿èµ·ç‚¹
 * @param canonicalRayDirection æ ‡å‡†åŒ–ç©ºé—´ä¸­çš„å°„çº¿æ–¹å‘ï¼ˆå•ä½å‘é‡ï¼‰
 * @return æœ€å°è·ç¦»çš„å¹³æ–¹å€¼
 */
[BackwardDifferentiable][ForceInline] float canonicalRayMinSquaredDistance(
    float3 canonicalRayOrigin,
    float3 canonicalRayDirection) {
    // ä½¿ç”¨å‘é‡å‰ç§¯è®¡ç®—å‚ç›´è·ç¦»å‘é‡
    const float3 gcrod = cross(canonicalRayDirection, canonicalRayOrigin);
    // è¿”å›è·ç¦»çš„å¹³æ–¹å€¼ï¼ˆé¿å…å¼€å¹³æ–¹æ ¹è¿ç®—æé«˜æ€§èƒ½ï¼‰
    return dot(gcrod, gcrod);
}

/**
 * è®¡ç®—æ ‡å‡†åŒ–ç©ºé—´ä¸­å°„çº¿çš„æœ€å¤§æ ¸å‡½æ•°å“åº”
 * 
 * æ ¹æ®ä¸åŒçš„æ ¸å‡½æ•°ç±»å‹ï¼Œè®¡ç®—å°„çº¿å¯¹é«˜æ–¯ç²’å­çš„æœ€å¤§å½±å“ã€‚
 * æ”¯æŒå¤šç§æ ¸å‡½æ•°ï¼Œä»çº¿æ€§åˆ°é«˜é˜¶å¤šé¡¹å¼ï¼Œæä¾›ä¸åŒçš„å…‰æ»‘åº¦ç‰¹æ€§ã€‚
 * 
 * æ ¸å‡½æ•°ç±»å‹ï¼š
 * - 0: Linear - çº¿æ€§å‡½æ•°ï¼Œè¾¹ç¼˜æ¸…æ™°ä½†ä¸å…‰æ»‘
 * - 1: Laplacian - æ‹‰æ™®æ‹‰æ–¯å‡½æ•°ï¼Œé€‚åº¦å…‰æ»‘
 * - 2: Quadratic (é»˜è®¤) - äºŒæ¬¡å‡½æ•°ï¼Œå¹³è¡¡æ€§èƒ½å’Œè´¨é‡
 * - 3: Cubic - ä¸‰æ¬¡å‡½æ•°ï¼Œæ›´å…‰æ»‘
 * - 4: Tesseractic - å››æ¬¡å‡½æ•°
 * - 5: Quintic - äº”æ¬¡å‡½æ•°
 * - 8: Zenzizenzizenzic - å…«æ¬¡å‡½æ•°ï¼Œæé«˜å…‰æ»‘åº¦
 * 
 * @param canonicalRayOrigin æ ‡å‡†åŒ–ç©ºé—´ä¸­çš„å°„çº¿èµ·ç‚¹
 * @param canonicalRayDirection æ ‡å‡†åŒ–ç©ºé—´ä¸­çš„å°„çº¿æ–¹å‘
 * @return æ ¸å‡½æ•°å“åº”å€¼ï¼ˆèŒƒå›´[0,1]ï¼‰
 */
[BackwardDifferentiable][ForceInline] float canonicalRayMaxKernelResponse<let KernelDegree : int>(
    float3 canonicalRayOrigin,
    float3 canonicalRayDirection) {
    // è®¡ç®—å°„çº¿åˆ°ç²’å­ä¸­å¿ƒçš„æœ€å°å¹³æ–¹è·ç¦»
    const float grayDist = canonicalRayMinSquaredDistance(canonicalRayOrigin, canonicalRayDirection);

    // å¹¿ä¹‰é«˜æ–¯å‡½æ•°ï¼Œé˜¶æ•°nçš„ç¼©æ”¾å› å­: s = -4.5/3^n
    switch (KernelDegree) {
    case 8: // Zenzizenzizenzicï¼ˆå…«æ¬¡å¹‚ï¼‰- æœ€é«˜å…‰æ»‘åº¦
    {
        /*static const*/ float s = -0.000685871056241;  // -4.5 / 3^8
        const float grayDistSq   = grayDist * grayDist;
        return exp(s * grayDistSq * grayDistSq);  // exp(s * d^8)
    }
    case 5: // Quinticï¼ˆäº”æ¬¡å¹‚ï¼‰
    {
        /*static const*/ float s = -0.0185185185185;    // -4.5 / 3^5
        return exp(s * grayDist * grayDist * sqrt(grayDist));  // exp(s * d^5)
    }
    case 4: // Tesseracticï¼ˆå››æ¬¡å¹‚ï¼‰
    {
        /*static const*/ float s = -0.0555555555556;    // -4.5 / 3^4
        return exp(s * grayDist * grayDist);  // exp(s * d^4)
    }
    case 3: // Cubicï¼ˆä¸‰æ¬¡å¹‚ï¼‰
    {
        /*static const*/ float s = -0.166666666667;     // -4.5 / 3^3
        return exp(s * grayDist * sqrt(grayDist));  // exp(s * d^3)
    }
    case 1: // Laplacianï¼ˆæ‹‰æ™®æ‹‰æ–¯ï¼‰
    {
        /*static const*/ float s = -1.5f;               // -4.5 / 3^1
        return exp(s * sqrt(grayDist));  // exp(s * d^1)
    }
    case 0: // Linearï¼ˆçº¿æ€§ï¼‰- éé«˜æ–¯å‡½æ•°ï¼Œæœ‰ç•Œæ”¯æŒ
    {
        /* static const */ float s = -0.329630334487;
        return max(1 + s * sqrt(grayDist), 0.f);  // çº¿æ€§é€’å‡ï¼Œä¸‹ç•Œä¸º0
    }
    default: // Quadraticï¼ˆäºŒæ¬¡å¹‚ï¼Œé»˜è®¤ï¼‰- æœ€å¸¸ç”¨çš„é«˜æ–¯å‡½æ•°
    {
        /*static const*/ float s = -0.5f;               // -4.5 / 3^2
        return exp(s * grayDist);  // exp(s * d^2)ï¼Œæ ‡å‡†é«˜æ–¯å‡½æ•°
    }
    }
}

// ========== æ ¸å¿ƒhitTè®¡ç®—å‡½æ•° - K-Bufferæ’åºçš„å…³é”®ï¼ ==========
//
// ã€åŠŸèƒ½ã€‘ï¼šè®¡ç®—å…‰çº¿ä¸é«˜æ–¯ç²’å­ç›¸äº¤çš„å‚æ•°åŒ–è·ç¦»ï¼ˆhitTï¼‰
// ã€é‡è¦æ€§ã€‘ï¼šè¿™æ˜¯K-Bufferå±€éƒ¨é‡æ’åºçš„æ ¸å¿ƒè®¡ç®—ï¼Œç›´æ¥å½±å“æ¸²æŸ“è´¨é‡ï¼
//
// ã€æ•°å­¦åŸç†ã€‘ï¼š
// åœ¨æ ‡å‡†åŒ–ç©ºé—´ä¸­ï¼Œè®¡ç®—å…‰çº¿åˆ°ç²’å­ä¸­å¿ƒæŠ•å½±ç‚¹çš„è·ç¦»
// å…‰çº¿æ–¹ç¨‹ï¼šP(t) = origin + t * direction
// æŠ•å½±ç‚¹ï¼št_opt = -dot(origin, direction) / dot(direction, direction)
// è·ç¦»ï¼š|P(t_opt) - center|ï¼Œå…¶ä¸­centeråœ¨æ ‡å‡†åŒ–ç©ºé—´ä¸ºåŸç‚¹
//
// ã€ä¸globalDepthçš„å…³é”®åŒºåˆ«ã€‘ï¼š
// - globalDepthï¼šç²’å­ä¸­å¿ƒåˆ°ç›¸æœºçš„æ¬§å‡ é‡Œå¾—è·ç¦»ï¼ˆç”¨äºç²—æ’åºï¼‰
// - hitTï¼šå…‰çº¿å‚æ•°åŒ–è·ç¦»ï¼Œè¡¨ç¤ºå…‰çº¿ä¸Šçš„å…·ä½“å‡»ä¸­ä½ç½®ï¼ˆç”¨äºç²¾æ’åºï¼‰
//
// ã€ä¸ºä»€ä¹ˆéœ€è¦hitTã€‘ï¼š
// å¯¹äºå¤§ç²’å­æˆ–æ¤­çƒç²’å­ï¼Œç²’å­ä¸­å¿ƒçš„æ·±åº¦å¯èƒ½ä¸å®é™…å‡»ä¸­è¡¨é¢çš„æ·±åº¦å·®å¼‚å¾ˆå¤§
// ä¾‹å¦‚ï¼šç²’å­ä¸­å¿ƒæ·±åº¦=10ï¼Œä½†å…‰çº¿å‡»ä¸­å‰è¡¨é¢æ·±åº¦=8ï¼Œå‡»ä¸­åè¡¨é¢æ·±åº¦=12
// K-Bufferéœ€è¦ç²¾ç¡®çš„å‡»ä¸­è·ç¦»æ¥æ­£ç¡®æ’åºé€æ˜æ··åˆ
//
[BackwardDifferentiable][ForceInline] float canonicalRayDistance(
    float3 canonicalRayOrigin,      // è¾“å…¥ï¼šæ ‡å‡†åŒ–ç©ºé—´ä¸­çš„å…‰çº¿èµ·ç‚¹
    float3 canonicalRayDirection,   // è¾“å…¥ï¼šæ ‡å‡†åŒ–ç©ºé—´ä¸­çš„å…‰çº¿æ–¹å‘ï¼ˆå•ä½å‘é‡ï¼‰
    float3 scale) {                 // è¾“å…¥ï¼šç²’å­çš„ä¸‰è½´ç¼©æ”¾å‚æ•°
    
    // ========== hitTè®¡ç®—çš„æ ¸å¿ƒç®—æ³• ==========
    // 
    // æ­¥éª¤1ï¼šè®¡ç®—å…‰çº¿æ–¹å‘ä¸èµ·ç‚¹çš„ç‚¹ç§¯æŠ•å½±
    // dot(canonicalRayDirection, -canonicalRayOrigin) å¾—åˆ°å…‰çº¿åˆ°åŸç‚¹çš„æœ€è¿‘ç‚¹å‚æ•°
    const float projectionParam = dot(canonicalRayDirection, -1 * canonicalRayOrigin);
    
    // æ­¥éª¤2ï¼šè®¡ç®—åŠ æƒæ–¹å‘å‘é‡
    // scale * canonicalRayDirection æŒ‰ç²’å­ç¼©æ”¾è°ƒæ•´æ–¹å‘
    // å†ä¹˜ä»¥æŠ•å½±å‚æ•°å¾—åˆ°æœ€ç»ˆçš„åŠ æƒè·ç¦»å‘é‡
    const float3 grds = scale * canonicalRayDirection * projectionParam;
    
    // æ­¥éª¤3ï¼šè®¡ç®—æœ€ç»ˆè·ç¦»
    // sqrt(dot(grds, grds)) å¾—åˆ°å‘é‡çš„æ¨¡é•¿ï¼Œå³å…‰çº¿å‚æ•°åŒ–è·ç¦»
    // è¿™ä¸ªè·ç¦»ä¼šè¢«è¿”å›ä½œä¸ºhitTï¼Œç”¨äºK-Bufferçš„ç²¾ç¡®æ’åº
    return sqrt(dot(grds, grds));
    
    // æ³¨æ„ï¼šè¿™ä¸ªå‡½æ•°çš„è¿”å›å€¼ç›´æ¥æˆä¸ºhit()å‡½æ•°ä¸­çš„depthå‚æ•°ï¼Œ
    // ä¹Ÿå°±æ˜¯K-Bufferä¸­çš„hitParticle.hitTï¼Œæ˜¯æ’åºçš„å…³é”®ä¾æ®ï¼
}

// ========== è¡¨é¢æ³•çº¿è®¡ç®—å‡½æ•° - å…‰ç…§å’Œé˜´å½±çš„åŸºç¡€ ==========
//
// ã€åŠŸèƒ½ã€‘ï¼šè®¡ç®—é«˜æ–¯ç²’å­è¡¨é¢åœ¨å‡»ä¸­ç‚¹çš„æ³•çº¿å‘é‡
// ã€ä½œç”¨ã€‘ï¼šç”¨äºå…‰ç…§è®¡ç®—ã€é˜´å½±ç”Ÿæˆå’Œæè´¨æ¸²æŸ“
//
// ã€Surfelæ¨¡å¼è¯´æ˜ã€‘ï¼š
// - Surfel = Surface Elementï¼Œè¡¨ç¤ºäºŒç»´é¢ç‰‡è€Œä¸æ˜¯ä¸‰ç»´ä½“ç§¯
// - åœ¨Surfelæ¨¡å¼ä¸‹ï¼Œç²’å­è¢«å‹ç¼©ä¸ºæè–„çš„é¢ç‰‡ï¼ˆzè½´ç¼©æ”¾â‰ˆ0ï¼‰
// - æ³•çº¿è®¡ç®—ç®€åŒ–ä¸ºé¢ç‰‡çš„æœå‘ï¼ˆé€šå¸¸æ˜¯zè½´æ–¹å‘ï¼‰
//
// ã€æ³•çº¿è®¡ç®—åŸç†ã€‘ï¼š
// 1. åœ¨Surfelæ¨¡å¼ä¸‹ï¼Œæ³•çº¿å›ºå®šä¸ºzè½´æ–¹å‘ï¼ˆé¢ç‰‡æ³•çº¿ï¼‰
// 2. åº”ç”¨ç²’å­çš„ç¼©æ”¾å’Œæ—‹è½¬å˜æ¢åˆ°ä¸–ç•Œç©ºé—´
// 3. ç¡®ä¿æ³•çº¿æœå‘ä¸å…‰çº¿æ–¹å‘ç›¸åï¼ˆèƒŒé¢å‰”é™¤ï¼‰
//
// ã€åº”ç”¨åœºæ™¯ã€‘ï¼š
// - å…‰ç…§è®¡ç®—ï¼šLambertå…‰ç…§æ¨¡å‹éœ€è¦è¡¨é¢æ³•çº¿
// - é˜´å½±æ˜ å°„ï¼šæ³•çº¿ç”¨äºè®¡ç®—é˜´å½±çš„è½¯ç¡¬ç¨‹åº¦
// - æè´¨æ¸²æŸ“ï¼šé•œé¢åå°„ã€æŠ˜å°„ç­‰éœ€è¦å‡†ç¡®çš„æ³•çº¿
//
[BackwardDifferentiable][ForceInline] float3 canonicalRayNormal<let Surfel : bool>(
    float3 canonicalRayOrigin,      // è¾“å…¥ï¼šæ ‡å‡†åŒ–ç©ºé—´ä¸­çš„å…‰çº¿èµ·ç‚¹
    float3 canonicalRayDirection,   // è¾“å…¥ï¼šæ ‡å‡†åŒ–ç©ºé—´ä¸­çš„å…‰çº¿æ–¹å‘
    float3 scale,                   // è¾“å…¥ï¼šç²’å­çš„ä¸‰è½´ç¼©æ”¾å‚æ•°
    float3x3 rotationT) {           // è¾“å…¥ï¼šç²’å­çš„æ—‹è½¬çŸ©é˜µè½¬ç½®
    
    // ========== Surfelæ³•çº¿è®¡ç®— ==========
    // 
    // æ­¥éª¤1ï¼šè®¾ç½®åŸºç¡€æ³•çº¿æ–¹å‘
    // åœ¨Surfelæ¨¡å¼ä¸‹ï¼Œé¢ç‰‡çš„æ³•çº¿é»˜è®¤ä¸ºZè½´æ­£æ–¹å‘
    // TODO: æœªæ¥å¯èƒ½éœ€è¦æ”¯æŒä»å‡ ä½•æ•°æ®ä¸­è·å–çœŸå®æ³•çº¿
    float3 surfelNm = float3(0, 0, 1);  // åŸºç¡€é¢ç‰‡æ³•çº¿ï¼ˆZè½´æ­£æ–¹å‘ï¼‰
    
    // æ­¥éª¤2ï¼šæ³•çº¿æ–¹å‘æ­§ä¹‰è§£å†³
    // ç¡®ä¿æ³•çº¿æœå‘ä¸å…‰çº¿å…¥å°„æ–¹å‘ç›¸åï¼Œå®ç°èƒŒé¢å‰”é™¤æ•ˆæœ
    // å¦‚æœæ³•çº¿ä¸å…‰çº¿æ–¹å‘å¤¹è§’å°äº90åº¦ï¼Œåˆ™ç¿»è½¬æ³•çº¿
    if (dot(surfelNm, canonicalRayDirection) > 0) {
        surfelNm *= -1.0f;  // ç¿»è½¬æ³•çº¿æ–¹å‘ï¼Œä½¿å…¶èƒŒå‘å…‰çº¿
    }
    
    // æ­¥éª¤3ï¼šå˜æ¢åˆ°ä¸–ç•Œç©ºé—´
    // åº”ç”¨ç²’å­çš„ç¼©æ”¾å’Œæ—‹è½¬å˜æ¢ï¼Œå°†å±€éƒ¨æ³•çº¿è½¬æ¢ä¸ºä¸–ç•Œç©ºé—´æ³•çº¿
    // surfelNm * scale: æŒ‰ç¼©æ”¾å› å­è°ƒæ•´æ³•çº¿ï¼ˆå¯¹äºå„å‘å¼‚æ€§ç¼©æ”¾å¾ˆé‡è¦ï¼‰
    // mul(..., rotationT): åº”ç”¨æ—‹è½¬çŸ©é˜µè½¬ç½®ï¼Œå°†æ³•çº¿è½¬æ¢åˆ°ä¸–ç•Œåæ ‡ç³»
    const float3 worldNormal = mul(surfelNm * scale, rotationT);
    
    // æ­¥éª¤4ï¼šå•ä½åŒ–æ³•çº¿
    // ç¡®ä¿è¿”å›çš„æ³•çº¿æ˜¯å•ä½å‘é‡ï¼Œæ»¡è¶³å…‰ç…§è®¡ç®—çš„è¦æ±‚
    return normalize(worldNormal);
    
    // æ³¨æ„ï¼šè¿™ä¸ªæ³•çº¿å°†ç”¨äºï¼š
    // - Lambertæ¼«åå°„å…‰ç…§ï¼šI = Ia + Id * max(0, dot(N, L))
    // - Phongé•œé¢åå°„ï¼šIs = Ip * pow(max(0, dot(R, V)), shininess)
    // - é˜´å½±æ˜ å°„ï¼šç¡®å®šè¡¨é¢æœå‘ä»¥è®¡ç®—é˜´å½±å¼ºåº¦
}

/**
 * å°„çº¿-é«˜æ–¯ç²’å­ç›¸äº¤æµ‹è¯•
 * 
 * æ ¸å¿ƒçš„ç›¸äº¤æµ‹è¯•å‡½æ•°ï¼Œåˆ¤æ–­å°„çº¿æ˜¯å¦ä¸é«˜æ–¯ç²’å­ç›¸äº¤ï¼Œå¹¶è®¡ç®—ç›¸å…³å‚æ•°ã€‚
 * ç›¸äº¤æµ‹è¯•åŸºäºæ ¸å‡½æ•°å“åº”å’Œå¯†åº¦é˜ˆå€¼ã€‚
 * 
 * ç®—æ³•æ­¥éª¤ï¼š
 * 1. å°†ä¸–ç•Œç©ºé—´å°„çº¿è½¬æ¢åˆ°ç²’å­çš„æ ‡å‡†åŒ–ç©ºé—´
 * 2. è®¡ç®—æ ¸å‡½æ•°å“åº”å€¼
 * 3. ç»“åˆå¯†åº¦è®¡ç®—alphaå€¼ï¼ˆä¸é€æ˜åº¦ï¼‰
 * 4. å¦‚æœè¶…è¿‡é˜ˆå€¼ï¼Œè®¡ç®—æ·±åº¦å’Œæ³•çº¿
 * 
 * @param rayOrigin ä¸–ç•Œç©ºé—´å°„çº¿èµ·ç‚¹
 * @param rayDirection ä¸–ç•Œç©ºé—´å°„çº¿æ–¹å‘å•ä½å‘é‡
 * @param parameters ç²’å­å‚æ•°
 * @param alpha è¾“å‡ºï¼šè®¡ç®—å¾—åˆ°çš„ä¸é€æ˜åº¦å€¼
 * @param depth è¾“å…¥è¾“å‡ºï¼šå‘½ä¸­æ·±åº¦ï¼ˆä»…åœ¨å‘½ä¸­æ—¶æ›´æ–°ï¼‰
 * @param enableNormal æ˜¯å¦éœ€è¦è®¡ç®—æ³•çº¿
 * @param normal è¾“å…¥è¾“å‡ºï¼šè¡¨é¢æ³•çº¿ï¼ˆä»…åœ¨å‘½ä¸­ä¸”enableNormal=trueæ—¶æ›´æ–°ï¼‰
 * @return æ˜¯å¦å‘½ä¸­ï¼ˆtrueè¡¨ç¤ºç›¸äº¤ï¼‰
 */
// ========== densityHitè°ƒç”¨é“¾ - ç¬¬4å±‚ï¼šæ ¸å¿ƒå®ç°ï¼ˆhitTè®¡ç®—çš„çœŸæ­£ä½ç½®ï¼ï¼‰==========
//
// è°ƒç”¨é“¾ç»“æ„ï¼š
// 1. K-Buffer (gutKBufferRenderer.cuh:326) â†’ particles.densityHit()
// 2. C++åŒ…è£… (shRadiativeGaussianParticles.cuh:115) â†’ particleDensityHit()
// 3. Slangå¯¼å‡º (gaussianParticles.slang:568) â†’ gaussianParticle.hit()
// 4. ã€å½“å‰å±‚ã€‘æ ¸å¿ƒå®ç° (gaussianParticles.slang:357) â†’ å®é™…è®¡ç®—hitT
//
// ã€æœ¬å±‚ä½œç”¨ã€‘ï¼šhitTçš„å®é™…è®¡ç®—é€»è¾‘
// - è¿™é‡Œæ˜¯K-Bufferä¸­hitParticle.hitTçš„çœŸæ­£è®¡ç®—ä½ç½®ï¼
// - å®ç°3Dé«˜æ–¯ç²’å­çš„å°„çº¿ç›¸äº¤ç®—æ³•
// - è®¡ç®—ç²¾ç¡®çš„å…‰çº¿å‚æ•°åŒ–è·ç¦»ç”¨äºK-Bufferé‡æ’åº

[BackwardDifferentiable][ForceInline]
bool hit(
    float3 rayOrigin,               // è¾“å…¥ï¼šå…‰çº¿èµ·ç‚¹ï¼ˆä¸–ç•Œç©ºé—´ï¼‰
    float3 rayDirection,            // è¾“å…¥ï¼šå…‰çº¿æ–¹å‘ï¼ˆä¸–ç•Œç©ºé—´ï¼‰
    Parameters parameters,          // è¾“å…¥ï¼š3Dé«˜æ–¯ç²’å­å‚æ•°ï¼ˆä½ç½®ã€æ—‹è½¬ã€ç¼©æ”¾ã€å¯†åº¦ï¼‰
    out float alpha,               // è¾“å‡ºï¼šä¸é€æ˜åº¦[0,1]
    inout float depth,             // è¾“å‡ºï¼šhitT - K-Bufferçš„å…³é”®æ’åºå‚æ•°ï¼
    no_diff bool enableNormal,     // è¾“å…¥ï¼šæ˜¯å¦è®¡ç®—æ³•çº¿
    inout float3 normal) {         // è¾“å‡ºï¼šè¡¨é¢æ³•çº¿

    // ========== ç¬¬1æ­¥ï¼šåæ ‡ç©ºé—´å˜æ¢ ==========
    // ç›®çš„ï¼šå°†æ¤­çƒå½¢é«˜æ–¯ç²’å­å˜æ¢ä¸ºå•ä½çƒï¼Œç®€åŒ–ç›¸äº¤è®¡ç®—
    // åŸç†ï¼šåº”ç”¨é€†å˜æ¢çŸ©é˜µï¼Œå°†å°„çº¿ä»ä¸–ç•Œç©ºé—´å˜æ¢åˆ°ç²’å­çš„æ ‡å‡†åŒ–ç©ºé—´
    float3 canonicalRayOrigin;      // å˜æ¢åçš„å…‰çº¿èµ·ç‚¹
    float3 canonicalRayDirection;   // å˜æ¢åçš„å…‰çº¿æ–¹å‘
    cannonicalRay(
        rayOrigin,                  // ä¸–ç•Œç©ºé—´å…‰çº¿èµ·ç‚¹
        rayDirection,               // ä¸–ç•Œç©ºé—´å…‰çº¿æ–¹å‘
        parameters,                 // ç²’å­å˜æ¢å‚æ•°ï¼ˆä½ç½®ã€æ—‹è½¬ã€ç¼©æ”¾ï¼‰
        canonicalRayOrigin,         // è¾“å‡ºï¼šæ ‡å‡†åŒ–ç©ºé—´èµ·ç‚¹
        canonicalRayDirection);     // è¾“å‡ºï¼šæ ‡å‡†åŒ–ç©ºé—´æ–¹å‘

    // ========== ç¬¬2æ­¥ï¼šæ ¸å‡½æ•°å“åº”è®¡ç®— ==========
    // ç›®çš„ï¼šè®¡ç®—3Dé«˜æ–¯æ ¸å‡½æ•°åœ¨æœ€è¿‘ç‚¹çš„å“åº”å€¼
    // åŸç†ï¼šexp(-0.5 * minSquaredDistance)ï¼Œå…¶ä¸­minSquaredDistanceæ˜¯å…‰çº¿åˆ°ç²’å­ä¸­å¿ƒçš„æœ€å°è·ç¦»å¹³æ–¹
    // è¿™ä¸ªå“åº”å€¼å†³å®šäº†ç²’å­å¯¹å…‰çº¿çš„å½±å“å¼ºåº¦
    const float maxResponse = canonicalRayMaxKernelResponse<KernelDegree>(
        canonicalRayOrigin,         // æ ‡å‡†åŒ–ç©ºé—´çš„å…‰çº¿èµ·ç‚¹
        canonicalRayDirection);     // æ ‡å‡†åŒ–ç©ºé—´çš„å…‰çº¿æ–¹å‘

    // ========== ç¬¬3æ­¥ï¼šä¸é€æ˜åº¦è®¡ç®— ==========
    // ç›®çš„ï¼šå°†æ ¸å‡½æ•°å“åº”è½¬æ¢ä¸ºå®é™…çš„ä¸é€æ˜åº¦å€¼
    // å…¬å¼ï¼šalpha = min(MaxAlpha, kernelResponse * particleDensity)
    // é™åˆ¶æœ€å¤§å€¼ä»¥ä¿è¯åå‘ä¼ æ’­çš„æ•°å€¼ç¨³å®šæ€§
    alpha = min(MaxParticleAlpha, maxResponse * parameters.density);
    
    // ========== ç¬¬4æ­¥ï¼šç›¸äº¤æœ‰æ•ˆæ€§éªŒè¯ ==========
    // ä½¿ç”¨åŒé‡é˜ˆå€¼æ£€æŸ¥ç¡®ä¿ç›¸äº¤çš„æœ‰æ•ˆæ€§ï¼š
    // 1. maxResponse > MinParticleKernelDensityï¼šæ ¸å‡½æ•°å“åº”è¶³å¤Ÿå¼º
    // 2. alpha > MinParticleAlphaï¼šæœ€ç»ˆä¸é€æ˜åº¦è¶³å¤Ÿé«˜
    const bool acceptHit = ((maxResponse > MinParticleKernelDensity) && (alpha > MinParticleAlpha));
    
    if (acceptHit)
    {
        // ========== ç¬¬5æ­¥ï¼šå…³é”®ï¼è®¡ç®—hitTè·ç¦» ==========
        // è¿™æ˜¯K-Bufferæ’åºçš„æ ¸å¿ƒï¼šè®¡ç®—å…‰çº¿å‚æ•°åŒ–è·ç¦»
        // depth = canonicalRayDistance() è¿”å›çš„æ˜¯å…‰çº¿å‚æ•°tï¼Œä½¿å¾—ï¼š
        //   hitPoint = rayOrigin + t * rayDirection
        // 
        // é‡è¦åŒºåˆ«ï¼š
        // - globalDepthï¼ˆå…¨å±€æ’åºï¼‰= distance(camera, particleCenter)
        // - hitTï¼ˆK-Bufferæ’åºï¼‰= å…‰çº¿ä¸ç²’å­è¡¨é¢ç›¸äº¤çš„å‚æ•°åŒ–è·ç¦»
        // 
        // ä¸ºä»€ä¹ˆéœ€è¦hitTè€Œä¸æ˜¯globalDepthï¼Ÿ
        // ä¾‹å­ï¼šå¤§ç²’å­çš„æƒ…å†µä¸‹ï¼Œç²’å­ä¸­å¿ƒå¯èƒ½å¾ˆè¿œï¼Œä½†å…‰çº¿å‡»ä¸­ç²’å­å‰è¡¨é¢å¾ˆè¿‘
        depth = canonicalRayDistance(canonicalRayOrigin,     // æ ‡å‡†åŒ–å…‰çº¿èµ·ç‚¹
                                    canonicalRayDirection,   // æ ‡å‡†åŒ–å…‰çº¿æ–¹å‘  
                                    parameters.scale);       // ç²’å­ç¼©æ”¾å‚æ•°
        
        // ========== ç¬¬6æ­¥ï¼šå¯é€‰çš„æ³•çº¿è®¡ç®— ==========
        // ä»…åœ¨éœ€è¦æ—¶è®¡ç®—è¡¨é¢æ³•çº¿ï¼ˆèŠ‚çœè®¡ç®—èµ„æºï¼‰
        if (enableNormal)
        {
            normal = canonicalRayNormal<Surfel>(canonicalRayOrigin,     // æ ‡å‡†åŒ–å…‰çº¿èµ·ç‚¹
                                              canonicalRayDirection,   // æ ‡å‡†åŒ–å…‰çº¿æ–¹å‘
                                              parameters.scale,        // ç²’å­ç¼©æ”¾
                                              parameters.rotationT);   // ç²’å­æ—‹è½¬è½¬ç½®çŸ©é˜µ
        }
    }
    
    // è¿”å›ç›¸äº¤æœ‰æ•ˆæ€§
    // å¦‚æœè¿”å›trueï¼Œåˆ™depthå‚æ•°åŒ…å«äº†K-Bufferéœ€è¦çš„ç²¾ç¡®hitTå€¼ï¼
    return acceptHit;
}

// ========== integrateHitè°ƒç”¨é“¾ - ç¬¬4å±‚ï¼šæ ¸å¿ƒå®ç°ç®—æ³• ==========
//
// ğŸ—ºï¸ ã€è°ƒç”¨é“¾ç»ˆç‚¹ã€‘ï¼š
// 1. K-Buffer (gutKBufferRenderer.cuh:244) â†’ particles.densityIntegrateHit()
// 2. C++åŒ…è£… (shRadiativeGaussianParticles.cuh:344) â†’ particleDensityIntegrateHit()
// 3. Slangå¯¼å‡º (gaussianParticles.slang:873) â†’ gaussianParticle.integrateHit<false>()
// 4. ã€å½“å‰å±‚ã€‘æ ¸å¿ƒå®ç° (gaussianParticles.slang:551) â†’ å®é™…Alphaæ··åˆè®¡ç®—
//
// ã€æœ¬å±‚ä½œç”¨ã€‘ï¼šä½“ç§¯æ¸²æŸ“æ ¸å¿ƒç®—æ³• - Alphaæ··åˆçš„æ•°å­¦å®ç°
// - è¿™æ˜¯æ•´ä¸ªè°ƒç”¨é“¾çš„æœ€åº•å±‚ï¼ŒåŒ…å«çœŸæ­£çš„æ•°å­¦è®¡ç®—é€»è¾‘
// - å®ç°æ ‡å‡†çš„Alphaæ··åˆå…¬å¼å’Œé€å°„ç‡æ›´æ–°
// - æ”¯æŒåŒå‘æ¸²æŸ“æ¨¡å¼ï¼šå‰å‘åï¼ˆK-Bufferä½¿ç”¨ï¼‰å’Œåå‘å‰
// - é€šè¿‡æ¨¡æ¿å‚æ•°<backToFront>åœ¨ç¼–è¯‘æ—¶ç”Ÿæˆä¸åŒçš„ä¼˜åŒ–ç‰ˆæœ¬
//
// ğŸ¨ ã€æ•°å­¦åŸç†ã€‘ï¼š
// Alphaæ··åˆå…¬å¼ï¼ˆPorter-Duffç†è®ºï¼‰ï¼š
// C_out = Î± Ã— C_src + (1-Î±) Ã— C_dst  // æ ‡å‡†Alphaæ··åˆ
// T_out = T_in Ã— (1-Î±)                    // é€å°„ç‡æ›´æ–°
// weight = Î± Ã— T_in                        // å®é™…è´¡çŒ®æƒé‡
//
// ã€æ¸²æŸ“æ¨¡å¼å¯¹æ¯”ã€‘ï¼š
// å‰å‘åæ¨¡å¼ (backToFront=false)ï¼š
//   weight = alpha * transmittance           // æ­£ç¡®çš„ç‰©ç†æƒé‡
//   integratedDepth += depth * weight        // ç´¯ç§¯å¹³å‡æ·±åº¦
//   transmittance *= (1 - alpha)             // é€å°„ç‡è¡°å‡
// åå‘å‰æ¨¡å¼ (backToFront=true)ï¼š
//   weight = alpha                           // ç›´æ¥ä½¿ç”¨alphaå€¼
//   integratedDepth = lerp(old, new, alpha)  // çº¿æ€§æ’å€¼æ··åˆ
//   transmittance *= (1 - alpha)             // åŒæ ·çš„é€å°„ç‡æ›´æ–°
//
// ğŸ“Š ã€æ€§èƒ½ä¼˜åŒ–ã€‘ï¼š
// - [BackwardDifferentiable] æ”¯æŒè‡ªåŠ¨å¾®åˆ†ï¼Œç”¨äºç¥ç»ç½‘ç»œè®­ç»ƒ
// - [ForceInline] å¼ºåˆ¶å†…è”å±•å¼€ï¼Œå‡å°‘å‡½æ•°è°ƒç”¨å¼€é”€
// - æ¨¡æ¿ç‰¹åŒ– <let backToFront : bool> ç¼–è¯‘æ—¶åˆ†æ”¯æ¶ˆé™¤
// - no_diff æ ‡è®°ä¸å‚ä¸æ¢¯åº¦è®¡ç®—çš„å‚æ•°ï¼Œä¼˜åŒ–å†…å­˜ä½¿ç”¨
//
/**
 * ç§¯åˆ†å•æ¬¡ç›¸äº¤ç»“æœï¼ˆä½“ç§¯æ¸²æŸ“æ··åˆï¼‰- æ ¸å¿ƒå®ç°ç®—æ³•
 *
 * ã€æ ¸å¿ƒåŠŸèƒ½ã€‘ï¼š
 * è¿™æ˜¯3DGUTæ¸²æŸ“ç³»ç»Ÿä¸­æœ€å…³é”®çš„æ•°å­¦å®ç°ï¼Œå®ç°ä½“ç§¯æ¸²æŸ“ä¸­å•ä¸ªç²’å­çš„è´¡çŒ®ç§¯åˆ†ã€‚
 * æ”¯æŒä¸¤ç§æ··åˆæ¨¡å¼ï¼Œé€šè¿‡æ¨¡æ¿å‚æ•°åœ¨ç¼–è¯‘æ—¶ä¼˜åŒ–ï¼š
 * 1. å‰å‘åæ¨¡å¼ï¼šç”¨äºæ­£å‘ç©¿è¶Šï¼Œç›´æ¥ç´¯åŠ æƒé‡å€¼ (K-Bufferä½¿ç”¨)
 * 2. åå‘å‰æ¨¡å¼ï¼šç”¨äºOveræ··åˆï¼Œä½¿ç”¨çº¿æ€§æ’å€¼ (Alphaæ··åˆ)
 *
 * è¿™ä¸ªå‡½æ•°å¤„ç†ï¼š
 * - æ·±åº¦ç§¯åˆ†ï¼ˆç”¨äºZ-bufferæˆ–è·ç¦»ä¼°è®¡ï¼‰
 * - æ³•çº¿ç§¯åˆ†ï¼ˆç”¨äºå…‰ç…§è®¡ç®—ï¼‰
 * - é€å°„ç‡æ›´æ–°ï¼ˆæ§åˆ¶åç»­ç²’å­çš„å½±å“ï¼‰
 *
 * @param alpha å½“å‰ç²’å­çš„ä¸é€æ˜åº¦ [0.0, 1.0]
 * @param transmittance è¾“å…¥è¾“å‡ºï¼šç´¯ç§¯é€å°„ç‡ [0.0, 1.0]
 * @param depth å½“å‰ç²’å­çš„æ·±åº¦ï¼ˆå‡»ä¸­è·ç¦»ï¼‰
 * @param integratedDepth è¾“å…¥è¾“å‡ºï¼šç´¯ç§¯æ·±åº¦ï¼ˆZ-bufferï¼‰
 * @param enableNormal æ˜¯å¦éœ€è¦å¤„ç†æ³•çº¿è®¡ç®—
 * @param normal å½“å‰ç²’å­çš„è¡¨é¢æ³•çº¿å‘é‡
 * @param integratedNormal è¾“å…¥è¾“å‡ºï¼šç´¯ç§¯æ³•çº¿å‘é‡
 * @return å½“å‰ç²’å­çš„æ··åˆæƒé‡ï¼ˆç”¨äºåç»­é¢œè‰²æ··åˆï¼‰
 */
// Slang	<let T : type>	func<let N : int>()
// C++ template <> template <int N> func()
[BackwardDifferentiable][ForceInline]
float integrateHit<let backToFront : bool>(
    in float alpha,
    inout float transmittance,
    in float depth,
    inout float integratedDepth,
    no_diff bool enableNormal,
    in float3 normal,
    inout float3 integratedNormal)
{
   // ========== æ­¥éª¤1ï¼šæ··åˆæƒé‡è®¡ç®— ==========
   // å…³é”®ï¼šæ ¹æ®æ¸²æŸ“æ¨¡å¼é€‰æ‹©ä¸åŒçš„æƒé‡è®¡ç®—æ–¹å¼
   // - K-Bufferä½¿ç”¨å‰å‘åæ¨¡å¼ï¼šweight = alpha * transmittance ï¼ˆç‰©ç†æ­£ç¡®ï¼‰
   // - åå‘å‰æ¨¡å¼ç›´æ¥ä½¿ç”¨alphaå€¼ï¼šweight = alpha
   const float weight = backToFront ? alpha : alpha * transmittance;
   
   // ========== æ­¥éª¤2ï¼šæ·±åº¦å’Œæ³•çº¿ç§¯åˆ† ==========
   if (backToFront)
   {
       // åå‘å‰æ¨¡å¼ï¼šOveræ··åˆï¼Œä½¿ç”¨çº¿æ€§æ’å€¼
       // å…¬å¼ï¼šresult = lerp(old, new, alpha) = old * (1-alpha) + new * alpha
       integratedDepth = lerp(integratedDepth, depth, alpha);
       if (enableNormal)
       {
           integratedNormal = lerp(integratedNormal, normal, alpha);
       }
   }
   else 
   {
       // å‰å‘åæ¨¡å¼ï¼šæ­£å‘ç©¿è¶Šï¼Œç›´æ¥ç´¯åŠ æƒé‡å€¼
       // å…¬å¼ï¼šresult += value * weight (åŠ æƒå¹³å‡)
       integratedDepth += depth * weight;
       if (enableNormal) 
       {
            integratedNormal += normal * weight;
       }
   }

   // ========== æ­¥éª¤3ï¼šé€å°„ç‡æ›´æ–° ==========
   // å…³é”®ï¼šæ¯ä¸ªç²’å­éƒ½ä¼šå‡å°‘åç»­å…‰çº¿çš„é€å°„ç‡
   // å…¬å¼ï¼šT_new = T_old * (1 - alpha) (æŒ‡æ•°è¡°å‡æ¨¡å‹)
   // ç‰©ç†æ„ä¹‰ï¼šå…‰çº¿è¢«ç²’å­éƒ¨åˆ†å¸æ”¶/æ•£å°„ï¼Œå‰©ä½™èƒ½é‡å‡å°‘
   transmittance *= (1 - alpha);
   
   // ========== æ­¥éª¤4ï¼šè¿”å›æƒé‡ç”¨äºé¢œè‰²æ··åˆ ==========
   // è¿”å›çš„æƒé‡å°†ç”±featureIntegrateFwdä½¿ç”¨ï¼Œå®ç°é¢œè‰²çš„Alphaæ··åˆ
   return weight;  // å½“å‰ç²’å­çš„å®é™…æ··åˆæƒé‡
}

/**
 * å¤„ç†å°„çº¿ä¸é«˜æ–¯ç²’å­ç›¸äº¤çš„å®Œæ•´æµç¨‹ - å¸¦æ¨¡æ¿å‚æ•°çš„é«˜æ•ˆå®ç°
 * 
 * ã€æ ¸å¿ƒåŠŸèƒ½ã€‘ï¼š
 * è¿™æ˜¯æ¸²æŸ“ç®¡çº¿ä¸­çš„å…³é”®å‡½æ•°ï¼Œå®Œæˆå°„çº¿-ç²’å­ç›¸äº¤çš„å®Œæ•´å¤„ç†ï¼š
 * 1. æ£€æµ‹ç›¸äº¤ (è°ƒç”¨ hit å‡½æ•°)
 * 2. è®¡ç®—è´¡çŒ® (è°ƒç”¨ integrateHit å‡½æ•°)
 * 3. æ”¯æŒåŒå‘æ··åˆæ¨¡å¼ (é€šè¿‡ let æ¨¡æ¿å‚æ•°ä¼˜åŒ–)
 * 
 * ã€let æ¨¡æ¿å‚æ•°çš„é‡è¦æ€§ã€‘ï¼š
 * <let backToFront : bool> æ˜¯ç¼–è¯‘æ—¶å¸¸é‡ï¼Œå…è®¸ç¼–è¯‘å™¨ç”Ÿæˆä¸¤ä¸ªä¸åŒçš„ä¼˜åŒ–ç‰ˆæœ¬ï¼š
 * - backToFront=true:  ä»åå¾€å‰çš„æ··åˆ (æ·±åº¦æ’åºæ¸²æŸ“)
 * - backToFront=false: ä»å‰å¾€åçš„æ··åˆ (æ ‡å‡†alphaæ··åˆ)
 * 
 * ã€æ¸²æŸ“æ¨¡å¼å¯¹æ¯”ã€‘ï¼š
 * å‰å‘åæ¸²æŸ“: color = color * (1-alpha) + particle_color * alpha
 * åå‘å‰æ¸²æŸ“: color = particle_color * alpha + color * (1-alpha)
 * æ•°å­¦ç­‰ä»·ä½†åœ¨æ•°å€¼ç²¾åº¦å’ŒGPUä¼˜åŒ–ä¸Šæœ‰å·®å¼‚
 * 
 * ã€å‡½æ•°å·¥ä½œæµç¨‹ã€‘ï¼š
 * Step 1: ä»ç¼“å†²åŒºè·å–ç²’å­å‚æ•° (fetchParameters)
 * Step 2: æ‰§è¡Œå°„çº¿-æ¤­çƒç›¸äº¤æµ‹è¯• (hit)
 * Step 3: å¦‚æœç›¸äº¤ï¼Œè®¡ç®—alphaæ··åˆè´¡çŒ® (integrateHit)
 * Step 4: è¿”å›æƒé‡å€¼ç”¨äºåç»­å¤„ç†
 * 
 * @param rayOrigin         å°„çº¿èµ·ç‚¹ (ä¸–ç•Œåæ ‡ï¼Œä¸å‚ä¸å¾®åˆ†)
 * @param rayDirection      å°„çº¿æ–¹å‘ (ä¸–ç•Œåæ ‡ï¼Œä¸å‚ä¸å¾®åˆ†)
 * @param particleIdx       ç²’å­ç´¢å¼• (ä¸å‚ä¸å¾®åˆ†)
 * @param parametersBuffer  å‚æ•°ç¼“å†²åŒº (ä¸å‚ä¸å¾®åˆ†)
 * @param transmittance     è¾“å…¥è¾“å‡ºï¼šå°„çº¿é€å°„ç‡ (å‚ä¸å¾®åˆ†)
 * @param integratedDepth   è¾“å…¥è¾“å‡ºï¼šç§¯åˆ†æ·±åº¦ (å‚ä¸å¾®åˆ†)
 * @param enableNormal      æ˜¯å¦è®¡ç®—æ³•çº¿ (ä¸å‚ä¸å¾®åˆ†)
 * @param integratedNormal  è¾“å…¥è¾“å‡ºï¼šç§¯åˆ†æ³•çº¿ (å‚ä¸å¾®åˆ†)
 * @return è¿”å›æ··åˆæƒé‡å€¼ï¼Œ0.0è¡¨ç¤ºæ— ç›¸äº¤
 */
[BackwardDifferentiable][ForceInline]
float processHitFromBuffer<let backToFront : bool>(
    no_diff float3 rayOrigin,
    no_diff float3 rayDirection,
    no_diff uint32_t particleIdx,
    no_diff RawParametersBuffer parametersBuffer,
    inout float transmittance,
    inout float integratedDepth,
    no_diff bool enableNormal,
    inout float3 integratedNormal)
{
    // åˆå§‹åŒ–å±€éƒ¨å˜é‡ï¼Œç”¨äºæ¥æ”¶ç›¸äº¤æµ‹è¯•ç»“æœ
    float alpha = 0.0f;    // ç²’å­ä¸é€æ˜åº¦ (è¾“å‡º)
    float depth;           // ç›¸äº¤è·ç¦» (è¾“å‡º)  
    float3 normal;         // è¡¨é¢æ³•çº¿ (è¾“å‡º)
    
    // ğŸ¯ æ ¸å¿ƒæ­¥éª¤ï¼šæ‰§è¡Œå°„çº¿-é«˜æ–¯æ¤­çƒç›¸äº¤æµ‹è¯•
    // hit() å‡½æ•°åŒ…å«äº†å®Œæ•´çš„å‡ ä½•è®¡ç®—ï¼š
    // 1. åæ ‡å˜æ¢ (ä¸–ç•Œç©ºé—´ â†’ ç²’å­å±€éƒ¨ç©ºé—´ â†’ æ ‡å‡†åŒ–ç©ºé—´)
    // 2. è·ç¦»è®¡ç®— (canonicalRayMinSquaredDistance)
    // 3. æ ¸å‡½æ•°å“åº” (canonicalRayMaxKernelResponse)  
    // 4. alphaå€¼è®¡ç®—å’Œé˜ˆå€¼æ£€æŸ¥
    if (hit(rayOrigin,                                          // å°„çº¿èµ·ç‚¹
            rayDirection,                                       // å°„çº¿æ–¹å‘
            fetchParameters(particleIdx, parametersBuffer),    // ä»ç¼“å†²åŒºè·å–ç²’å­å‚æ•°
            alpha,                                             // [è¾“å‡º] è®¡ç®—å¾—åˆ°çš„ä¸é€æ˜åº¦
            depth,                                             // [è¾“å‡º] å‡»ä¸­è·ç¦»
            enableNormal,                                      // æ˜¯å¦éœ€è¦è®¡ç®—æ³•çº¿
            normal))                                           // [è¾“å‡º] è¡¨é¢æ³•çº¿
    {
        // âœ… ç›¸äº¤æˆåŠŸï¼è°ƒç”¨æ··åˆå‡½æ•°å¤„ç†è´¡çŒ®
        // ğŸš€ è¿™é‡Œä½¿ç”¨äº† let æ¨¡æ¿å‚æ•° <backToFront>ï¼Œç¼–è¯‘å™¨ä¼šç”Ÿæˆä¼˜åŒ–çš„ç‰¹åŒ–ç‰ˆæœ¬
        return integrateHit<backToFront>(alpha,           // å½“å‰ç²’å­çš„ä¸é€æ˜åº¦
                                         transmittance,   // [è¾“å…¥è¾“å‡º] å°„çº¿å‰©ä½™é€å°„ç‡
                                         depth,           // å‡»ä¸­è·ç¦»ï¼Œç”¨äºæ·±åº¦ç§¯åˆ†
                                         integratedDepth, // [è¾“å…¥è¾“å‡º] ç´¯ç§¯æ·±åº¦å€¼
                                         enableNormal,    // æ˜¯å¦å¤„ç†æ³•çº¿
                                         normal,          // å½“å‰è¡¨é¢æ³•çº¿
                                         integratedNormal); // [è¾“å…¥è¾“å‡º] ç´¯ç§¯æ³•çº¿
    }
    
    // âŒ æ— ç›¸äº¤ï¼Œè¿”å›é›¶æƒé‡
    return 0.0f;
}

/**
 * è®¡ç®—é«˜æ–¯ç²’å­çš„åæ–¹å·®çŸ©é˜µ - æ¤­çƒå‡ ä½•çš„æ•°å­¦æ ¸å¿ƒ
 * 
 * ã€æ•°å­¦åŸç†ã€‘ï¼š
 * åæ–¹å·®çŸ©é˜µ Î£ å®Œå…¨æè¿°äº†é«˜æ–¯åˆ†å¸ƒçš„å½¢çŠ¶å’Œæœå‘ï¼š
 * Î£ = R * S * S^T * R^T
 * 
 * å…¶ä¸­ï¼š
 * - R: æ—‹è½¬çŸ©é˜µ (3Ã—3)ï¼Œæ§åˆ¶æ¤­çƒçš„æœå‘
 * - S: å¯¹è§’ç¼©æ”¾çŸ©é˜µ diag(scale_x, scale_y, scale_z)ï¼Œæ§åˆ¶æ¤­çƒå„è½´é•¿
 * 
 * @param parameters ç²’å­å‚æ•°ï¼ŒåŒ…å«ä½ç½®ã€ç¼©æ”¾å’Œæ—‹è½¬ä¿¡æ¯
 * @return 3Ã—3 åæ–¹å·®çŸ©é˜µï¼Œæè¿°é«˜æ–¯æ¤­çƒçš„å®Œæ•´å‡ ä½•å½¢çŠ¶
 */
[BackwardDifferentiable][ForceInline] float3x3 computeCovariance(
    in Parameters parameters) {
    // ğŸ§® æ•°å­¦å…¬å¼ï¼šÎ£ = R * S * S^T * R^T = (R*S) * (R*S)^T
    // æ­¥éª¤1: è®¡ç®— StRt = R * S (æ—‹è½¬çŸ©é˜µå³ä¹˜ç¼©æ”¾)
    // è¿™é‡Œåˆ©ç”¨äº† parameters.rotationT å·²ç»æ˜¯è½¬ç½®ï¼Œæ‰€ä»¥å®é™…è®¡ç®—çš„æ˜¯ S * R^T
    const float3x3 StRt = float3x3(
        parameters.scale.x * parameters.rotationT[0],  // ç¬¬ä¸€åˆ—ï¼šXè½´ç¼©æ”¾ * æ—‹è½¬ç¬¬ä¸€è¡Œ
        parameters.scale.y * parameters.rotationT[1],  // ç¬¬äºŒåˆ—ï¼šYè½´ç¼©æ”¾ * æ—‹è½¬ç¬¬äºŒè¡Œ  
        parameters.scale.z * parameters.rotationT[2]   // ç¬¬ä¸‰åˆ—ï¼šZè½´ç¼©æ”¾ * æ—‹è½¬ç¬¬ä¸‰è¡Œ
    );
    
    // æ­¥éª¤2: è®¡ç®—æœ€ç»ˆåæ–¹å·®çŸ©é˜µ Î£ = StRt^T * StRt
    // transpose(StRt) å¾—åˆ° (S*R^T)^T = R*S^Tï¼Œç„¶åå³ä¹˜ StRt = S*R^T
    // ç»“æœï¼š(R*S^T) * (S*R^T) = R * S^T * S * R^T = R * S * S^T * R^T = Î£
    return mul(transpose(StRt), StRt);
}

/**
 * è®¡ç®—ä»å…‰æºåˆ°ç²’å­çš„å…¥å°„æ–¹å‘å‘é‡ - å…‰ç…§è®¡ç®—çš„åŸºç¡€
 * ã€æ•°å­¦è®¡ç®—ã€‘ï¼š
 * å…¥å°„æ–¹å‘ = normalize(ç²’å­ä½ç½® - å…‰æºä½ç½®)
 * @param parameters    ç²’å­å‚æ•°ï¼ŒåŒ…å«ä½ç½®ä¿¡æ¯
 * @param sourcePosition å…‰æºä½ç½® (ä¸å‚ä¸å¾®åˆ†ï¼Œé€šå¸¸æ˜¯ç›¸æœºä½ç½®)
 * @return å½’ä¸€åŒ–çš„å…¥å°„æ–¹å‘å‘é‡ (ä»å…‰æºæŒ‡å‘ç²’å­)
 */
[BackwardDifferentiable] [ForceInline]
float3 incidentDirectionFromParameters(
    Parameters parameters,
    no_diff float3 sourcePosition
)
{
    // ğŸŒŸ è®¡ç®—ä»å…‰æºåˆ°ç²’å­çš„æ–¹å‘å‘é‡å¹¶å½’ä¸€åŒ–
    // å‘é‡å‡æ³•ï¼šç²’å­ä½ç½® - å…‰æºä½ç½® = ä»å…‰æºæŒ‡å‘ç²’å­çš„å‘é‡
    // normalize: è½¬æ¢ä¸ºå•ä½å‘é‡ï¼Œåªä¿ç•™æ–¹å‘ä¿¡æ¯
    return normalize(parameters.position - sourcePosition);
}

/**
 * ä»ç¼“å†²åŒºè®¡ç®—å…¥å°„æ–¹å‘ - incidentDirectionFromParameters çš„ç¼“å†²åŒºç‰ˆæœ¬
 * 
 * ã€åŠŸèƒ½ã€‘ï¼š
 * è¿™æ˜¯ incidentDirectionFromParameters çš„ä¾¿åˆ©åŒ…è£…å‡½æ•°ï¼Œ
 * è‡ªåŠ¨ä»ç¼“å†²åŒºè·å–ç²’å­å‚æ•°åè®¡ç®—å…¥å°„æ–¹å‘ã€‚
 * 
 * ã€ä½¿ç”¨åœºæ™¯ã€‘ï¼š
 * åœ¨æ¸²æŸ“å¾ªç¯ä¸­ï¼Œé€šå¸¸åªæœ‰ç²’å­ç´¢å¼•è€Œä¸æ˜¯ç›´æ¥çš„å‚æ•°å¯¹è±¡ï¼Œ
 * è¿™ä¸ªå‡½æ•°é¿å…äº†æ‰‹åŠ¨è°ƒç”¨ fetchParameters çš„æ­¥éª¤ã€‚
 * 
 * ã€è¿”å›å€¼ç‰¹æ€§ã€‘ï¼š
 * è¿”å›å€¼æ ‡è®°ä¸º no_diffï¼Œæ„å‘³ç€è¿™ä¸ªæ–¹å‘å‘é‡æœ¬èº«ä¸å‚ä¸æ¢¯åº¦è®¡ç®—ï¼Œ
 * ä½†é€šè¿‡ fetchParameters è·å–çš„ç²’å­ä½ç½®ä»ç„¶å¯ä»¥æ¥æ”¶æ¢¯åº¦ã€‚
 * 
 * ã€è°ƒç”¨é“¾ã€‘ï¼š
 * incidentDirectionFromBuffer â†’ fetchParameters â†’ incidentDirectionFromParameters
 * 
 * @param particleIdx       ç²’å­ç´¢å¼• (ä¸å‚ä¸å¾®åˆ†)
 * @param parametersBuffer  å‚æ•°ç¼“å†²åŒº (ä¸å‚ä¸å¾®åˆ†)  
 * @param sourcePosition    å…‰æºä½ç½® (ä¸å‚ä¸å¾®åˆ†)
 * @return å½’ä¸€åŒ–çš„å…¥å°„æ–¹å‘å‘é‡ (æ ‡è®°ä¸ºä¸å‚ä¸å¾®åˆ†)
 */
[BackwardDifferentiable][ForceInline]
no_diff float3 incidentDirectionFromBuffer(
    no_diff uint32_t particleIdx,
    no_diff RawParametersBuffer parametersBuffer,
    no_diff float3 sourcePosition
)
{
    // ğŸ”„ ä¸¤æ­¥å¼è°ƒç”¨ï¼šå…ˆè·å–å‚æ•°ï¼Œå†è®¡ç®—æ–¹å‘
    // 1. fetchParameters: ä»ç¼“å†²åŒºè·å–ç²’å­çš„å®Œæ•´å‚æ•°
    // 2. incidentDirectionFromParameters: ä½¿ç”¨å‚æ•°è®¡ç®—å…¥å°„æ–¹å‘
    return incidentDirectionFromParameters(
        fetchParameters(particleIdx, parametersBuffer),
        sourcePosition
    );
}
} // namespace gaussianParticle

// ------------------------------------------------------------------------------------------------------------------
// å¯¼å‡ºå‡½æ•°å…¥å£ç‚¹ (CUDA Device Export Functions)
//
// ä»¥ä¸‹å‡½æ•°æ˜¯ä¸ºCUDAè®¾å¤‡ç«¯å¯¼å‡ºçš„å…¥å£ç‚¹ï¼Œå¯ä»¥è¢«C++/CUDAä»£ç è°ƒç”¨ã€‚
// è¿™äº›å‡½æ•°å°è£…äº†æ ¸å¿ƒçš„é«˜æ–¯ç²’å­è®¡ç®—åŠŸèƒ½ï¼Œæä¾›ç»Ÿä¸€çš„æ¥å£ã€‚

/**
 * è·å–ç²’å­å¯†åº¦è®¡ç®—å‚æ•°
 * 
 * ä»ç¼“å†²åŒºè·å–æŒ‡å®šç²’å­çš„è®¡ç®—ä¼˜åŒ–å‚æ•°ï¼Œç”¨äºå¯†åº¦è®¡ç®—ã€‚
 * è¿”å›çš„å‚æ•°åŒ…å«é¢„è®¡ç®—çš„æ—‹è½¬çŸ©é˜µè½¬ç½®ï¼Œæé«˜è®¡ç®—æ•ˆç‡ã€‚
 * 
 * @param particleIdx ç²’å­ç´¢å¼•
 * @param commonParameters é€šç”¨å‚æ•°é…ç½®
 * @return ä¼˜åŒ–åçš„ç²’å­å‚æ•°ç»“æ„
 */
[CudaDeviceExport] 
inline gaussianParticle.Parameters particleDensityParameters(
    uint32_t particleIdx,
    gaussianParticle.CommonParameters commonParameters) 
{
    return gaussianParticle.fetchParameters(
        particleIdx,
        commonParameters.parametersBuffer);
}

// ========== densityHitè°ƒç”¨é“¾ - ç¬¬3å±‚ï¼šSlangå¯¼å‡ºæ¥å£ ==========
//
// è°ƒç”¨é“¾ç»“æ„ï¼š
// 1. K-Buffer (gutKBufferRenderer.cuh:326) â†’ particles.densityHit()
// 2. C++åŒ…è£… (shRadiativeGaussianParticles.cuh:115) â†’ particleDensityHit()
// 3. ã€å½“å‰å±‚ã€‘Slangå¯¼å‡º (gaussianParticles.slang:568) â†’ gaussianParticle.hit()
// 4. æ ¸å¿ƒå®ç° (gaussianParticles.slang:357) â†’ å®é™…è®¡ç®—hitT
//
// ã€æœ¬å±‚ä½œç”¨ã€‘ï¼šè·¨è¯­è¨€è¾¹ç•Œæ¥å£
// - [CudaDeviceExport] ä½¿å¾—Slangå‡½æ•°å¯ä»¥è¢«CUDA C++ä»£ç è°ƒç”¨
// - æä¾›ç¨³å®šçš„ABIè¾¹ç•Œï¼Œéš”ç¦»Slangå†…éƒ¨å®ç°ç»†èŠ‚
// - ç®€å•çš„å‡½æ•°è°ƒç”¨è½¬å‘ï¼Œä¸è¿›è¡Œä»»ä½•è®¡ç®—

/**
 * ç²’å­å¯†åº¦ç›¸äº¤æµ‹è¯• - Slangå¯¼å‡ºæ¥å£
 * 
 * åŠŸèƒ½ï¼šä¸ºCUDA C++ä»£ç æä¾›è°ƒç”¨Slangå®ç°çš„densityHitåŠŸèƒ½çš„æ¥å£
 * ä½œç”¨ï¼šè¿™æ˜¯ä¸€ä¸ªçº¯è½¬å‘å‡½æ•°ï¼Œå°†è°ƒç”¨ç›´æ¥ä¼ é€’ç»™å†…éƒ¨çš„gaussianParticle.hit()
 * 
 * é‡è¦ï¼šæœ¬å‡½æ•°ä¸åšä»»ä½•è®¡ç®—ï¼Œåªæ˜¯è¯­è¨€è¾¹ç•Œçš„æ¡¥æ¢
 * - CUDA C++ â†’ [CudaDeviceExport] â†’ Slangå†…éƒ¨å®ç°
 * - ç¡®ä¿å‚æ•°ç±»å‹å…¼å®¹æ€§å’Œè°ƒç”¨çº¦å®šæ­£ç¡®æ€§
 * 
 * @param rayOrigin å°„çº¿èµ·ç‚¹ï¼ˆä¸–ç•Œç©ºé—´åæ ‡ï¼‰
 * @param rayDirection å°„çº¿æ–¹å‘ï¼ˆä¸–ç•Œç©ºé—´å•ä½å‘é‡ï¼‰
 * @param parameters ç²’å­å‚æ•°ï¼ˆä½ç½®ã€æ—‹è½¬ã€ç¼©æ”¾ã€å¯†åº¦ç­‰ï¼‰
 * @param alpha è¾“å‡ºï¼šä¸é€æ˜åº¦å€¼ [0,1]
 * @param depth è¾“å‡ºï¼šç›¸äº¤æ·±åº¦ï¼ˆè¿™å°±æ˜¯K-Bufferéœ€è¦çš„hitTï¼ï¼‰
 * @param enableNormal æ˜¯å¦è®¡ç®—è¡¨é¢æ³•çº¿
 * @param normal è¾“å‡ºï¼šè¡¨é¢æ³•çº¿å‘é‡
 * @return æ˜¯å¦å‘ç”Ÿæœ‰æ•ˆç›¸äº¤ï¼ˆé€šè¿‡é˜ˆå€¼æ£€æµ‹ï¼‰
 */
[CudaDeviceExport]
inline bool particleDensityHit(
    float3 rayOrigin,                           // è¾“å…¥ï¼šå…‰çº¿èµ·ç‚¹
    float3 rayDirection,                        // è¾“å…¥ï¼šå…‰çº¿æ–¹å‘
    gaussianParticle.Parameters parameters,     // è¾“å…¥ï¼šç²’å­å‚æ•°ç»“æ„
    out float alpha,                           // è¾“å‡ºï¼šä¸é€æ˜åº¦
    out float depth,                           // è¾“å‡ºï¼šhitTè·ç¦»ï¼ˆå…³é”®ï¼ï¼‰
    bool enableNormal,                         // è¾“å…¥ï¼šæ˜¯å¦éœ€è¦æ³•çº¿
    out float3 normal)                         // è¾“å‡ºï¼šè¡¨é¢æ³•çº¿
{
    // ========== å®Œæ•´æ¸²æŸ“ç¢°æ’æ£€æµ‹ï¼šç›´æ¥è½¬å‘åˆ°æ ¸å¿ƒå®ç° ==========
    //
    // ã€å‡½æ•°èŒè´£ã€‘ï¼š
    // è¿™æ˜¯æ¸²æŸ“ç®¡çº¿ä¸­æœ€å¸¸ç”¨çš„ç¢°æ’æ£€æµ‹æ¥å£ï¼Œæä¾›å®Œæ•´çš„ç›¸äº¤ä¿¡æ¯ï¼š
    // 1. âœ… Alphaå€¼è®¡ç®—ï¼šç”¨äºé€æ˜åº¦æ··åˆ
    // 2. âœ… ç²¾ç¡®æ·±åº¦ï¼šç”¨äºæ·±åº¦ç¼“å†²å’Œæ’åº  
    // 3. âœ… è¡¨é¢æ³•çº¿ï¼šç”¨äºå…‰ç…§è®¡ç®—
    // 4. âœ… è‡ªåŠ¨å¾®åˆ†ï¼šæ”¯æŒæ¢¯åº¦åå‘ä¼ æ’­
    //
    // ã€ä¸å…¶ä»–hitå‡½æ•°çš„å¯¹æ¯”ã€‘ï¼š
    // - æœ¬å‡½æ•°ï¼šå®Œæ•´åŠŸèƒ½ï¼Œé€‚åˆæœ€ç»ˆæ¸²æŸ“
    // - HitCustomï¼šåªå‡ ä½•æµ‹è¯•ï¼Œé€‚åˆé¢„ç­›é€‰
    // - HitInstanceï¼šé¢„å˜æ¢ä¼˜åŒ–ï¼Œé€‚åˆæ‰¹é‡å¤„ç†
    //
    // ã€å…³é”®è¾“å‡ºè¯´æ˜ã€‘ï¼š
    // depthå‚æ•°è¿”å›çš„æ˜¯ç²¾ç¡®çš„hitTå€¼ï¼Œè¿™å¯¹K-Bufferæ’åºè‡³å…³é‡è¦ï¼š
    // - globalDepthï¼šç²’å­ä¸­å¿ƒåˆ°ç›¸æœºçš„è·ç¦»ï¼ˆç”¨äºç²—æ’åºï¼‰
    // - hitT (depth)ï¼šå…‰çº¿å®é™…å‡»ä¸­ç²’å­è¡¨é¢çš„å‚æ•°åŒ–è·ç¦»ï¼ˆç”¨äºç²¾æ’åºï¼‰
    //
    // ã€è°ƒç”¨é“¾è·¯å¾„ã€‘ï¼š
    // C++ â†’ [CudaDeviceExport] â†’ gaussianParticle.hit() â†’ å®Œæ•´æ•°å­¦è®¡ç®—
    //
    return gaussianParticle.hit(rayOrigin,      // è½¬å‘ï¼šå…‰çº¿èµ·ç‚¹
                                rayDirection,    // è½¬å‘ï¼šå…‰çº¿æ–¹å‘
                                parameters,      // è½¬å‘ï¼šç²’å­å‚æ•°
                                alpha,          // è½¬å‘ï¼šä¸é€æ˜åº¦è¾“å‡º (å…³é”®æ¸²æŸ“ä¿¡æ¯!)
                                depth,          // è½¬å‘ï¼šhitTè¾“å‡º (ç²¾ç¡®æ·±åº¦!)
                                enableNormal,   // è½¬å‘ï¼šæ³•çº¿è®¡ç®—æ ‡å¿—
                                normal);        // è½¬å‘ï¼šè¡¨é¢æ³•çº¿è¾“å‡º
}

// ========== particleDensityIntegrateHitè°ƒç”¨é“¾ - ç¬¬3å±‚ï¼šSlangå¯¼å‡ºæ¥å£ ==========
//
// ğŸ”— ã€è°ƒç”¨é“¾ä½ç½®ã€‘ï¼š
// 1. K-Buffer (gutKBufferRenderer.cuh:244) â†’ particles.densityIntegrateHit()
// 2. C++åŒ…è£… (shRadiativeGaussianParticles.cuh:344) â†’ particleDensityIntegrateHit()
// 3. ã€å½“å‰å±‚ã€‘Slangå¯¼å‡º (gaussianParticles.slang:873) â†’ gaussianParticle.integrateHit<false>()
// 4. æ ¸å¿ƒå®ç° (gaussianParticles.slang:551) â†’ å®é™…Alphaæ··åˆè®¡ç®—
//
// ã€æœ¬å±‚ä½œç”¨ã€‘ï¼šè·¨è¯­è¨€è¾¹ç•Œçš„ç¨³å®šå¯¼å‡ºæ¥å£
// - [CudaDeviceExport] ä½¿å¾—Slangå‡½æ•°å¯ä»¥è¢«CUDA C++ä»£ç è°ƒç”¨
// - æä¾›ç¨³å®šçš„ABIè¾¹ç•Œï¼Œéš”ç¦»Slangå†…éƒ¨å®ç°ç»†èŠ‚
// - çº¯è½¬å‘å‡½æ•°ï¼Œä¸è¿›è¡Œä»»ä½•è®¡ç®—ï¼Œåªåšè¯­è¨€è¾¹ç•Œçš„æ¡¥æ¢
// - ç¡®ä¿å‚æ•°ç±»å‹å…¼å®¹æ€§å’Œè°ƒç”¨çº¦å®šæ­£ç¡®æ€§
//
// ã€æ¸²æŸ“æ¨¡å¼ã€‘ï¼š
// - ä½¿ç”¨å‰å‘åéå†æ¨¡å¼ (backToFront=false)
// - é€‚ç”¨äºæ­£å‘ç©¿è¶Šçš„æ¸²æŸ“ç®—æ³• (front-to-back ray marching)
// - ç›´æ¥ç´¯ç§¯æ¨¡å¼ï¼šintegratedDepth += depth * weight
//
// ğŸ“Š ã€æ ¸å¿ƒå…¬å¼ã€‘ï¼ˆå°†åœ¨ç¬¬4å±‚å®ç°ï¼‰ï¼š
// const float weight = alpha * transmittance;  // æƒé‡è®¡ç®—
// integratedDepth += depth * weight;           // æ·±åº¦ç´¯ç§¯
// transmittance *= (1 - alpha);               // é€å°„ç‡æ›´æ–°
// return weight;                               // è¿”å›æƒé‡ç”¨äºé¢œè‰²æ··åˆ
//
/**
 * ç²’å­å¯†åº¦ç›¸äº¤ç§¯åˆ†ï¼ˆå‰å‘æ¨¡å¼ï¼‰- Slangå¯¼å‡ºæ¥å£
 * 
 * åŠŸèƒ½ï¼šä¸ºCUDA C++ä»£ç æä¾›è°ƒç”¨Slangå®ç°çš„densityIntegrateHitåŠŸèƒ½çš„æ¥å£
 * ä½œç”¨ï¼šè¿™æ˜¯ä¸€ä¸ªçº¯è½¬å‘å‡½æ•°ï¼Œå°†è°ƒç”¨ç›´æ¥ä¼ é€’ç»™å†…éƒ¨çš„gaussianParticle.integrateHit()
 * 
 * é‡è¦ï¼šæœ¬å‡½æ•°ä¸åšä»»ä½•è®¡ç®—ï¼Œåªæ˜¯è¯­è¨€è¾¹ç•Œçš„æ¡¥æ¢
 * - CUDA C++ â†’ [CudaDeviceExport] â†’ Slangå†…éƒ¨å®ç°
 * - ç¡®ä¿å‚æ•°ç±»å‹å…¼å®¹æ€§å’Œè°ƒç”¨çº¦å®šæ­£ç¡®æ€§
 * 
 * @param alpha ç²’å­çš„ä¸é€æ˜åº¦ [0.0, 1.0]
 * @param transmittance è¾“å…¥è¾“å‡ºï¼šç´¯ç§¯é€å°„ç‡ï¼ˆä¼šè¢«ä¿®æ”¹ï¼‰
 * @param depth ç²’å­æ·±åº¦ï¼ˆå‡»ä¸­è·ç¦»ï¼‰
 * @param integratedDepth è¾“å…¥è¾“å‡ºï¼šç´¯ç§¯æ·±åº¦ï¼ˆä¼šè¢«ä¿®æ”¹ï¼‰
 * @param enableNormal æ˜¯å¦éœ€è¦å¤„ç†æ³•çº¿è®¡ç®—
 * @param normal ç²’å­è¡¨é¢æ³•çº¿å‘é‡
 * @param integratedNormal è¾“å…¥è¾“å‡ºï¼šç´¯ç§¯æ³•çº¿å‘é‡ï¼ˆä¼šè¢«ä¿®æ”¹ï¼‰
 * @return ç²’å­çš„æ··åˆæƒé‡ï¼ˆalpha * transmittanceï¼‰
 */
[CudaDeviceExport] inline float particleDensityIntegrateHit(
    in float alpha,
    inout float transmittance,
    in float depth,
    inout float integratedDepth,
    in bool enableNormal,
    in float3 normal,
    inout float3 integratedNormal) 
{
    // ========== ç›´æ¥è½¬å‘åˆ°æ ¸å¿ƒå®ç°å±‚ ==========
    // åŠŸèƒ½ï¼šå°†æ‰€æœ‰å‚æ•°åŸå°ä¸åŠ¨åœ°ä¼ é€’ç»™çœŸæ­£çš„ç®—æ³•å®ç°
    // æ¨¡æ¿å‚æ•°ï¼š<false> è¡¨ç¤ºä½¿ç”¨å‰å‘åæ¸²æŸ“æ¨¡å¼
    // è¿”å›å€¼ï¼šç›´æ¥è¿”å›æ ¸å¿ƒç®—æ³•è®¡ç®—çš„æƒé‡å€¼
    return gaussianParticle.integrateHit<false>(
        alpha,              // ç²’å­ä¸é€æ˜åº¦
        transmittance,      // å½“å‰é€å°„ç‡ï¼ˆè¾“å…¥è¾“å‡ºï¼‰
        depth,              // ç²’å­æ·±åº¦
        integratedDepth,    // ç§¯åˆ†æ·±åº¦ï¼ˆè¾“å…¥è¾“å‡ºï¼‰
        enableNormal,       // æ³•çº¿è®¡ç®—æ ‡å¿—
        normal,             // å½“å‰æ³•çº¿
        integratedNormal);  // ç§¯åˆ†æ³•çº¿ï¼ˆè¾“å…¥è¾“å‡ºï¼‰
}

/**
 * ç›´æ¥ä»ç¼“å†²åŒºå¤„ç†ç²’å­ç›¸äº¤ï¼ˆå‰å‘æ¨¡å¼ï¼‰
 * 
 * é«˜æ•ˆçš„ä¸€ç«™å¼å‡½æ•°ï¼Œç»„åˆäº†å‚æ•°è·å–ã€ç›¸äº¤æµ‹è¯•å’Œç§¯åˆ†æ“ä½œã€‚
 * é€‚ç”¨äºæ¸²æŸ“å¾ªç¯ä¸­çš„ç›´æ¥è°ƒç”¨ï¼Œå‡å°‘å‡½æ•°è°ƒç”¨å¼€é”€ã€‚
 * 
 * @param rayOrigin å°„çº¿èµ·ç‚¹
 * @param rayDirection å°„çº¿æ–¹å‘
 * @param particleIdx ç²’å­ç´¢å¼•
 * @param commonParameters é€šç”¨å‚æ•°
 * @param transmittance è¾“å…¥è¾“å‡ºï¼šé€å°„ç‡
 * @param integratedDepth è¾“å…¥è¾“å‡ºï¼šç§¯åˆ†æ·±åº¦
 * @param enableNormal æ˜¯å¦å¤„ç†æ³•çº¿
 * @param integratedNormal è¾“å…¥è¾“å‡ºï¼šç§¯åˆ†æ³•çº¿
 * @return ç²’å­çš„æ··åˆæƒé‡ï¼ˆæ— ç›¸äº¤æ—¶ä¸º0ï¼‰
 */
[CudaDeviceExport]
inline float particleDensityProcessHitFwdFromBuffer(
    float3 rayOrigin,
    float3 rayDirection,
    uint32_t particleIdx,
    gaussianParticle.CommonParameters commonParameters,
    inout float transmittance,
    inout float integratedDepth,
    in bool enableNormal,
    inout float3 integratedNormal) 
{
    return gaussianParticle.processHitFromBuffer<false>(
        rayOrigin,
        rayDirection,
        particleIdx,
        commonParameters.parametersBuffer,
        transmittance,
        integratedDepth,
        enableNormal,
        integratedNormal);
}

/**
 * é«˜æ–¯ç²’å­ç¢°æ’å¤„ç†çš„åå‘ä¼ æ’­å‡½æ•° - è‡ªåŠ¨å¾®åˆ†ç³»ç»Ÿçš„æ ¸å¿ƒ
 *
 * ã€æ ¸å¿ƒåŠŸèƒ½ã€‘ï¼š
 * è¿™æ˜¯ä½“ç§¯æ¸²æŸ“ä¸­æœ€é‡è¦çš„åå‘ä¼ æ’­å‡½æ•°ï¼Œè´Ÿè´£è®¡ç®—æ‰€æœ‰å‚ä¸æ¸²æŸ“çš„å‚æ•°æ¢¯åº¦ã€‚
 * å®ç°äº†å¤æ‚çš„é“¾å¼æ³•åˆ™è®¡ç®—ï¼Œå°†è¾“å‡ºæ¢¯åº¦åå‘ä¼ æ’­åˆ°ç²’å­å‚æ•°ã€‚
 *
 * ã€æ•°å­¦åŸç† - ä½“ç§¯æ¸²æŸ“çš„åå‘æ¨¡å¼ã€‘ï¼š
 * å‰å‘ç§¯åˆ†å…¬å¼ï¼š
 *   transmittance_new = transmittance_old * (1 - alpha)
 *   depth_new = depth_old + alpha * hit_depth
 *   normal_new = normal_old + alpha * hit_normal
 *
 * åå‘ä¼ æ’­ï¼šä½¿ç”¨é“¾å¼æ³•åˆ™æ¢å¤çŠ¶æ€å¹¶è®¡ç®—æ¢¯åº¦
 *   weight = 1.0 / (1 - alpha)  // åå‘æƒé‡
 *   transmittance = transmittance_new * weight  // æ¢å¤åŸå§‹é€å°„ç‡
 *   depth = (depth_new - alpha * hit_depth) * weight  // æ¢å¤åŸå§‹æ·±åº¦
 *
 * ã€å·¥ä½œæµç¨‹ã€‘ï¼š
 * 1. ğŸ”„ çŠ¶æ€æ¢å¤ï¼šå°†å‰å‘ç§¯åˆ†çš„ç»“æœé€†å‘æ¢å¤åˆ°ç§¯åˆ†å‰çŠ¶æ€
 * 2. ğŸ“¦ æ¢¯åº¦åŒ…è£…ï¼šå°†å€¼å’Œæ¢¯åº¦åŒ…è£…ä¸º DifferentialPair å¯¹è±¡
 * 3. ğŸ§  è‡ªåŠ¨å¾®åˆ†ï¼šè°ƒç”¨ bwd_diff() å¼•æ“è®¡ç®—å‚æ•°æ¢¯åº¦
 * 4. ğŸ“¤ æ¢¯åº¦æå–ï¼šä» DifferentialPair ä¸­æå–è®¡ç®—å¾—åˆ°çš„æ¢¯åº¦
 *
 * ã€å…³é”®æŠ€æœ¯ - DifferentialPairã€‘ï¼š
 * Slangçš„åŒæ•°ï¼ˆDual Numberï¼‰å®ç°ï¼Œæ¯ä¸ªå€¼éƒ½æºå¸¦å…¶æ¢¯åº¦ï¼š
 *   DifferentialPair<T> = { value: T, differential: T }
 * æ”¯æŒè‡ªåŠ¨è·Ÿè¸ªæ•´ä¸ªè®¡ç®—å›¾çš„æ¢¯åº¦æµã€‚
 *
 * ã€åº”ç”¨åœºæ™¯ã€‘ï¼š
 * - ğŸ“ ç¥ç»è¾å°„åœºè®­ç»ƒï¼šä¼˜åŒ–é«˜æ–¯ç²’å­çš„ä½ç½®ã€æ—‹è½¬ã€ç¼©æ”¾
 * - ğŸ¨ å¯å¾®æ¸²æŸ“ï¼šå®ç°åŸºäºæ¢¯åº¦çš„åœºæ™¯é‡å»º
 * - ğŸ”§ å‚æ•°ä¼˜åŒ–ï¼šç«¯åˆ°ç«¯è®­ç»ƒæ•´ä¸ªæ¸²æŸ“ç®¡çº¿
 *
 * @param rayOrigin             å°„çº¿èµ·ç‚¹ (ä¸–ç•Œåæ ‡ï¼Œä¸å‚ä¸å¾®åˆ†)
 * @param rayDirection          å°„çº¿æ–¹å‘ (ä¸–ç•Œåæ ‡ï¼Œä¸å‚ä¸å¾®åˆ†)  
 * @param particleIdx           ç²’å­ç´¢å¼• (ä¸å‚ä¸å¾®åˆ†)
 * @param commonParameters      å…¬å…±å‚æ•°ç¼“å†²åŒº (ä¸å‚ä¸å¾®åˆ†)
 * @param alpha                 å‰å‘ï¼šç²’å­ä¸é€æ˜åº¦å€¼ (è¾“å…¥)
 * @param alphaGrad             åå‘ï¼šä¸é€æ˜åº¦æ¢¯åº¦ (è¾“å…¥)
 * @param transmittance         å‰å‘ï¼šé€å°„ç‡ | åå‘ï¼šæ¢å¤åçš„é€å°„ç‡ (è¾“å…¥è¾“å‡º)
 * @param transmittanceGrad     åå‘ï¼šé€å°„ç‡æ¢¯åº¦ (è¾“å…¥è¾“å‡º)
 * @param depth                 å‰å‘ï¼šå‡»ä¸­æ·±åº¦ (è¾“å…¥)
 * @param integratedDepth       å‰å‘ï¼šç§¯åˆ†æ·±åº¦ | åå‘ï¼šæ¢å¤åçš„ç§¯åˆ†æ·±åº¦ (è¾“å…¥è¾“å‡º)
 * @param integratedDepthGrad   åå‘ï¼šç§¯åˆ†æ·±åº¦æ¢¯åº¦ (è¾“å…¥è¾“å‡º)
 * @param enableNormal          æ˜¯å¦å¤„ç†æ³•çº¿ (ä¸å‚ä¸å¾®åˆ†)
 * @param normal                å‰å‘ï¼šè¡¨é¢æ³•çº¿ (è¾“å…¥)
 * @param integratedNormal      å‰å‘ï¼šç§¯åˆ†æ³•çº¿ | åå‘ï¼šæ¢å¤åçš„ç§¯åˆ†æ³•çº¿ (è¾“å…¥è¾“å‡º)
 * @param integratedNormalGrad  åå‘ï¼šç§¯åˆ†æ³•çº¿æ¢¯åº¦ (è¾“å…¥è¾“å‡º)
 */
[CudaDeviceExport]
void particleDensityProcessHitBwdToBuffer(
    // å°„çº¿ä¿¡æ¯ï¼ˆè¾“å…¥ï¼Œä¸å‚ä¸æ¢¯åº¦ï¼‰
    float3 rayOrigin,
    float3 rayDirection,
    uint32_t particleIdx,
    gaussianParticle.CommonParameters commonParameters,
    // å‰å‘ä¼ æ’­çš„å€¼å’Œå¯¹åº”æ¢¯åº¦
    in float alpha,
    in float alphaGrad,
    inout float transmittance,
    inout float transmittanceGrad,
    in float depth,
    inout float integratedDepth,
    inout float integratedDepthGrad,
    bool enableNormal,
    in float3 normal,
    inout float3 integratedNormal,
    inout float3 integratedNormalGrad) 
{
    if (alpha > 0.0f)
    {
        // æ­¥éª¤1:æ¢å¤å‰å‘çŠ¶æ€
        const float weight = 1.0f / (1.0f - alpha);

        transmittance *= weight;
        // è¿™æ˜¯Slangçš„åŒæ•°ï¼ˆDual Numberï¼‰å®ç°ï¼š
        // å€¼éƒ¨åˆ†ï¼šå‰å‘è®¡ç®—ç»“æœ
        // å¾®åˆ†éƒ¨åˆ†ï¼šåå‘ä¼ æ’­æ¢¯åº¦
        // è‡ªåŠ¨è·Ÿè¸ªï¼šè®¡ç®—è¿‡ç¨‹ä¸­çš„æ¢¯åº¦ä¼ æ’­
        DifferentialPair<float> transmittanceDiff = DifferentialPair<float>(transmittance, transmittanceGrad);
        
        // æ­¥éª¤2:æ¢å¤ç§¯åˆ†æ·±åº¦
        integratedDepth = (integratedDepth - depth * alpha) * weight;
        DifferentialPair<float> integratedDepthDiff = DifferentialPair<float>(integratedDepth, integratedDepthGrad);

        DifferentialPair<float3> integratedNormalDiff;
        if (enableNormal)
        {
            integratedNormal = (integratedNormal - normal * alpha) * weight;
            integratedNormalDiff = DifferentialPair<float3>(integratedNormal, integratedNormalGrad);
        }
        else
        {
            integratedNormalDiff = DifferentialPair<float3>(float3(0), float3(0));
        }

        // æ­¥éª¤3:è°ƒç”¨è‡ªåŠ¨å¾®åˆ†å¼•æ“
        bwd_diff(gaussianParticle.processHitFromBuffer<true>)(
            rayOrigin,
            rayDirection,
            particleIdx,
            commonParameters.parametersBuffer,
            transmittanceDiff,
            integratedDepthDiff,
            enableNormal,
            integratedNormalDiff,
            alphaGrad);

        transmittanceGrad = transmittanceDiff.getDifferential();
        integratedDepthGrad = integratedDepthDiff.getDifferential();
        if (enableNormal)
        {
            integratedNormalGrad = integratedNormalDiff.getDifferential();
        }
    }
}

/**
 * è‡ªå®šä¹‰é«˜æ–¯ç²’å­ç¢°æ’æ£€æµ‹ - K-Bufferæ¸²æŸ“å™¨çš„ä¸“ç”¨å‡½æ•°
 *
 * ã€æ ¸å¿ƒåŠŸèƒ½ã€‘ï¼š
 * è¿™æ˜¯ä¸ºK-Bufferæ·±åº¦æ’åºæ¸²æŸ“ä¼˜åŒ–çš„ç¢°æ’æ£€æµ‹å‡½æ•°ï¼Œä¸“é—¨ç”¨äºå¿«é€Ÿç¡®å®š
 * å°„çº¿æ˜¯å¦ä¸é«˜æ–¯ç²’å­ç›¸äº¤ï¼Œå¹¶è®¡ç®—ç²¾ç¡®çš„å‡»ä¸­è·ç¦»ç”¨äºæ·±åº¦æ’åºã€‚
 *
 * ã€ä¸æ ‡å‡†hitå‡½æ•°çš„åŒºåˆ«ã€‘ï¼š
 * - æ ‡å‡†hitï¼šè®¡ç®—alphaå€¼ï¼Œç”¨äºé¢œè‰²æ··åˆ
 * - æœ¬å‡½æ•°ï¼šåªè®¡ç®—å‡ ä½•ç›¸äº¤ï¼Œç”¨äºæ·±åº¦æ’åº
 * - æ€§èƒ½ä¼˜åŒ–ï¼šè·³è¿‡å¤æ‚çš„æ ¸å‡½æ•°è®¡ç®—ï¼Œåªåšå‡ ä½•æµ‹è¯•
 *
 * ã€å·¥ä½œæµç¨‹ã€‘ï¼š
 * 1. ğŸ” å‚æ•°è·å–ï¼šä»ç¼“å†²åŒºè·å–æŒ‡å®šç²’å­çš„å‡ ä½•å‚æ•°
 * 2. ğŸ¯ åæ ‡å˜æ¢ï¼šå°†ä¸–ç•Œç©ºé—´å°„çº¿è½¬æ¢åˆ°ç²’å­æ ‡å‡†åŒ–ç©ºé—´
 * 3. ğŸ“Š æ ¸å“åº”è®¡ç®—ï¼šè®¡ç®—æœ€å¤§å¯èƒ½çš„æ ¸å‡½æ•°å“åº”å€¼
 * 4. ğŸ“ è·ç¦»è®¡ç®—ï¼šè®¡ç®—å°„çº¿åˆ°ç²’å­ä¸­å¿ƒæŠ•å½±çš„å‚æ•°åŒ–è·ç¦»
 * 5. âœ… å¤šé‡æ£€æµ‹ï¼šæ‰§è¡Œè·ç¦»èŒƒå›´å’Œå‡ ä½•ç›¸äº¤çš„è”åˆæµ‹è¯•
 *
 * ã€æ•°å­¦åŸç†ã€‘ï¼š
 * å‡»ä¸­è·ç¦» = canonicalRayDistance() è®¡ç®—çš„æ˜¯å°„çº¿å‚æ•°tå€¼ï¼š
 *   hit_point = rayOrigin + t * rayDirection
 * å…¶ä¸­tå°±æ˜¯hitDistanceï¼Œä»£è¡¨æ²¿å°„çº¿æ–¹å‘çš„å‚æ•°åŒ–è·ç¦»ã€‚
 *
 * ã€K-Bufferåº”ç”¨ã€‘ï¼š
 * K-Bufferéœ€è¦å¯¹æ¯ä¸ªåƒç´ ç»´æŠ¤Kä¸ªæœ€è¿‘çš„ç¢°æ’ç‚¹ï¼š
 * 1. å¿«é€Ÿç­›é€‰ï¼šä½¿ç”¨æœ¬å‡½æ•°ç¡®å®šç›¸äº¤æ€§
 * 2. è·ç¦»æ’åºï¼šä½¿ç”¨hitDistanceè¿›è¡Œæ·±åº¦æ’åº  
 * 3. ç²¾ç¡®æ¸²æŸ“ï¼šåªå¯¹æ’åºåçš„å‰Kä¸ªç²’å­è¿›è¡Œå®Œæ•´æ¸²æŸ“
 *
 * ã€æ€§èƒ½ä¼˜åŒ–ç­–ç•¥ã€‘ï¼š
 * - ğŸš€ å‡ ä½•è£å‰ªï¼šé€šè¿‡è·ç¦»èŒƒå›´å¿«é€Ÿå‰”é™¤ä¸ç›¸å…³ç²’å­
 * - ğŸ¯ ç²¾ç¡®æµ‹è¯•ï¼šä½¿ç”¨canonicalRayMinSquaredDistanceåšæœ€ç»ˆéªŒè¯
 * - ğŸ“ˆ æ‰¹é‡å¤„ç†ï¼šæ”¯æŒå¹¶è¡Œå¤„ç†å¤§é‡å°„çº¿-ç²’å­å¯¹
 *
 * @param rayOrigin                    å°„çº¿èµ·ç‚¹ (ä¸–ç•Œåæ ‡)
 * @param rayDirection                 å°„çº¿æ–¹å‘ (ä¸–ç•Œåæ ‡ï¼Œå•ä½å‘é‡)
 * @param particleIdx                  ç›®æ ‡ç²’å­ç´¢å¼•
 * @param commonParameters             å…¬å…±å‚æ•°ç¼“å†²åŒº
 * @param minHitDistance              æœ€å°æœ‰æ•ˆå‡»ä¸­è·ç¦» (è¿‘è£å‰ªé¢)
 * @param maxHitDistance              æœ€å¤§æœ‰æ•ˆå‡»ä¸­è·ç¦» (è¿œè£å‰ªé¢)
 * @param maxParticleSquaredDistance  æœ€å¤§ç²’å­å¹³æ–¹è·ç¦»é˜ˆå€¼ (å‡ ä½•ç›¸äº¤åˆ¤æ–­)
 * @param hitDistance                 è¾“å‡ºï¼šå‚æ•°åŒ–å‡»ä¸­è·ç¦» (å°„çº¿å‚æ•°tå€¼)
 * @return æ˜¯å¦å‘ç”Ÿæœ‰æ•ˆç›¸äº¤ (é€šè¿‡æ‰€æœ‰å‡ ä½•å’Œè·ç¦»æµ‹è¯•)
 */
[CudaDeviceExport]
bool particleDensityHitCustom(
    float3 rayOrigin,
    float3 rayDirection,
    int32_t particleIdx,
    gaussianParticle.CommonParameters commonParameters,
    float minHitDistance,
    float maxHitDistance,
    float maxParticleSquaredDistance,
    out float hitDistance
)
{
    // ========== K-Bufferä¼˜åŒ–ï¼šå‡ ä½•ç¢°æ’æ£€æµ‹ç®¡çº¿ ==========
    //
    // ã€è®¾è®¡æ€æƒ³ã€‘ï¼š
    // æœ¬å‡½æ•°ä¸“ä¸ºK-Bufferæ·±åº¦æ’åºä¼˜åŒ–ï¼Œåªå…³å¿ƒå‡ ä½•ç›¸äº¤è€Œéæ¸²æŸ“ç»†èŠ‚ã€‚
    // è·³è¿‡æ˜‚è´µçš„alphaå’Œæ³•çº¿è®¡ç®—ï¼Œä¸“æ³¨äºå¿«é€Ÿçš„è·ç¦»æµ‹è¯•ã€‚
    //
    
    // æ­¥éª¤1: ğŸ” å‚æ•°è·å– - ä»GPUç¼“å†²åŒºè¯»å–ç²’å­å‡ ä½•å‚æ•°
    gaussianParticle.Parameters parameters = gaussianParticle.fetchParameters(particleIdx, commonParameters.parametersBuffer);

    // æ­¥éª¤2: ğŸ¯ åæ ‡ç©ºé—´å˜æ¢ - å°†ä¸–ç•Œç©ºé—´è½¬æ¢ä¸ºç²’å­æ ‡å‡†åŒ–ç©ºé—´
    // è¿™æ˜¯é«˜æ–¯ç›¸äº¤çš„æ ¸å¿ƒï¼šå°†æ¤­çƒæ ‡å‡†åŒ–ä¸ºå•ä½çƒï¼Œç®€åŒ–åç»­è®¡ç®—
    float3 canonicalRayOrigin;      // å˜æ¢åçš„å°„çº¿èµ·ç‚¹
    float3 canonicalRayDirection;   // å˜æ¢åçš„å°„çº¿æ–¹å‘
    gaussianParticle.cannonicalRay(
        rayOrigin,                  // è¾“å…¥ï¼šä¸–ç•Œç©ºé—´å°„çº¿èµ·ç‚¹
        rayDirection,               // è¾“å…¥ï¼šä¸–ç•Œç©ºé—´å°„çº¿æ–¹å‘
        parameters,                 // è¾“å…¥ï¼šç²’å­å˜æ¢å‚æ•°(ä½ç½®ã€æ—‹è½¬ã€ç¼©æ”¾)
        canonicalRayOrigin,         // è¾“å‡ºï¼šæ ‡å‡†åŒ–ç©ºé—´å°„çº¿èµ·ç‚¹
        canonicalRayDirection);     // è¾“å‡ºï¼šæ ‡å‡†åŒ–ç©ºé—´å°„çº¿æ–¹å‘

    // æ­¥éª¤3: ğŸ“Š æ ¸å‡½æ•°å“åº”è®¡ç®— - è®¡ç®—å°„çº¿åœ¨é«˜æ–¯æ ¸å‡½æ•°ä¸­çš„æœ€å¤§å“åº”å€¼
    // æ³¨æ„ï¼šè¿™é‡Œè®¡ç®—äº†maxResponseä½†å®é™…ä¸Šåœ¨åç»­åˆ¤æ–­ä¸­å¹¶æœªä½¿ç”¨
    // å¯èƒ½æ˜¯ä¸ºäº†ä¿æŒä¸å®Œæ•´hitå‡½æ•°çš„æ¥å£ä¸€è‡´æ€§æˆ–æœªæ¥æ‰©å±•é¢„ç•™
    const float maxResponse = gaussianParticle.canonicalRayMaxKernelResponse<gaussianParticle.KernelDegree>(
        canonicalRayOrigin,         // æ ‡å‡†åŒ–å°„çº¿èµ·ç‚¹
        canonicalRayDirection);     // æ ‡å‡†åŒ–å°„çº¿æ–¹å‘

    // æ­¥éª¤4: ğŸ“ å‡ ä½•è·ç¦»è®¡ç®— - è®¡ç®—å°„çº¿å‚æ•°tå€¼ (å…³é”®!)
    // è¿™æ˜¯K-Bufferæ’åºçš„æ ¸å¿ƒæ•°æ®ï¼šå°„çº¿åˆ°é«˜æ–¯ä¸­å¿ƒæŠ•å½±çš„å‚æ•°åŒ–è·ç¦»
    hitDistance = gaussianParticle.canonicalRayDistance(canonicalRayOrigin, canonicalRayDirection, parameters.scale);

    // æ­¥éª¤5: âœ… ä¸‰é‡éªŒè¯ - è”åˆå‡ ä½•æµ‹è¯•ç¡®ä¿æœ‰æ•ˆç›¸äº¤
    // ä¸‰ä¸ªæ¡ä»¶å¿…é¡»åŒæ—¶æ»¡è¶³æ‰ç®—æœ‰æ•ˆå‡»ä¸­ï¼š
    return (hitDistance > minHitDistance) &&           // æ¡ä»¶1: è·ç¦»èŒƒå›´æ£€æŸ¥ (è¿‘è£å‰ªé¢)
           (hitDistance < maxHitDistance) &&           // æ¡ä»¶2: è·ç¦»èŒƒå›´æ£€æŸ¥ (è¿œè£å‰ªé¢)  
           (gaussianParticle.canonicalRayMinSquaredDistance(   // æ¡ä»¶3: å‡ ä½•ç›¸äº¤éªŒè¯
                canonicalRayOrigin, canonicalRayDirection) < maxParticleSquaredDistance);
    //
    // ã€æœ€ç»ˆåˆ¤æ–­é€»è¾‘ã€‘ï¼š
    // åªæœ‰å½“å°„çº¿åœ¨æœ‰æ•ˆè·ç¦»èŒƒå›´å†…ï¼Œä¸”ç¡®å®ä¸é«˜æ–¯æ¤­çƒå‡ ä½•ç›¸äº¤æ—¶ï¼Œ
    // æ‰è¿”å›trueå¹¶è¾“å‡ºæœ‰æ•ˆçš„hitDistanceä¾›K-Bufferæ’åºä½¿ç”¨ã€‚
}

/**
 * å®ä¾‹åŒ–é«˜æ–¯ç²’å­ç¢°æ’æ£€æµ‹ - é¢„å˜æ¢å°„çº¿çš„è¶…é«˜é€Ÿæ£€æµ‹
 *
 * ã€æ ¸å¿ƒåŠŸèƒ½ã€‘ï¼š
 * è¿™æ˜¯æœ€é«˜æ€§èƒ½çš„ç¢°æ’æ£€æµ‹å‡½æ•°ï¼Œä¸“é—¨å¤„ç†å·²ç»è¿‡åæ ‡å˜æ¢çš„å°„çº¿ã€‚
 * è·³è¿‡å¤æ‚çš„åæ ‡å˜æ¢æ­¥éª¤ï¼Œç›´æ¥åœ¨æ ‡å‡†åŒ–ç©ºé—´ä¸­è¿›è¡Œå‡ ä½•è®¡ç®—ã€‚
 *
 * ã€ä¸å…¶ä»–hitå‡½æ•°çš„æ€§èƒ½å¯¹æ¯”ã€‘ï¼š
 * - particleDensityHitï¼šå®Œæ•´è®¡ç®—ï¼ŒåŒ…å«alphaå€¼ (æœ€æ…¢ï¼Œæœ€å®Œæ•´)
 * - particleDensityHitCustomï¼šå‡ ä½•æ£€æµ‹ï¼ŒåŒ…å«åæ ‡å˜æ¢ (ä¸­ç­‰é€Ÿåº¦)
 * - ã€æœ¬å‡½æ•°ã€‘ï¼šé¢„å˜æ¢å°„çº¿ï¼Œçº¯å‡ ä½•è®¡ç®— (æœ€å¿«ï¼Œé€‚åˆæ‰¹é‡å¤„ç†)
 *
 * ã€é¢„å¤„ç†ä¼˜åŠ¿ã€‘ï¼š
 * è¾“å…¥çš„å°„çº¿å·²ç»è¿‡ canonicalRay() å˜æ¢ï¼Œæ„å‘³ç€ï¼š
 * 1. ğŸ¯ æ¤­çƒ â†’ å•ä½çƒï¼šé«˜æ–¯æ¤­çƒå·²æ ‡å‡†åŒ–ä¸ºå•ä½çƒ
 * 2. ğŸ”§ åæ ‡å½’ä¸€åŒ–ï¼šæ‰€æœ‰è®¡ç®—éƒ½åœ¨æ ‡å‡†åŒ–ç©ºé—´è¿›è¡Œ
 * 3. âš¡ è·³è¿‡å˜æ¢ï¼šçœå»è€—æ—¶çš„çŸ©é˜µå˜æ¢æ­¥éª¤
 *
 * ã€æ•°å­¦åŸç† - å°„çº¿åˆ°åŸç‚¹æœ€è¿‘ç‚¹ã€‘ï¼š
 * åœ¨æ ‡å‡†åŒ–ç©ºé—´ä¸­ï¼Œè®¡ç®—å°„çº¿åˆ°åŸç‚¹(æ¤­çƒä¸­å¿ƒ)çš„æœ€è¿‘è·ç¦»å‚æ•°ï¼š
 *
 * å°„çº¿æ–¹ç¨‹ï¼šP(t) = origin + t * direction
 * ç›®æ ‡ï¼šæœ€å°åŒ– |P(t)|Â² = |origin + t * direction|Â²
 *
 * æ±‚å¯¼å¹¶ä»¤å…¶ä¸º0ï¼š
 * d/dt[|origin + t * direction|Â²] = 0
 * 2(origin + t * direction) Â· direction = 0
 * 2(origin Â· direction + t * |direction|Â²) = 0
 * t = -(origin Â· direction) / |direction|Â²
 *
 * ã€å®ç°ç»†èŠ‚ã€‘ï¼š
 * numerator = -dot(canonicalRayOrigin, canonicalUnormalizedRayDirection)
 * denominator = rcp(dot(canonicalUnormalizedRayDirection, canonicalUnormalizedRayDirection))
 * hitDistance = numerator * denominator
 *
 * ã€åº”ç”¨åœºæ™¯ã€‘ï¼š
 * - ğŸš€ å®ä¾‹åŒ–æ¸²æŸ“ï¼šå¤§é‡ç›¸åŒå‡ ä½•çš„é«˜æ•ˆå¤„ç†
 * - ğŸ“Š æ‰¹é‡æµ‹è¯•ï¼šé¢„å…ˆå˜æ¢å°„çº¿ï¼Œç„¶åå¹¶è¡Œæµ‹è¯•å¤šä¸ªç²’å­
 * - ğŸ® å®æ—¶æ¸²æŸ“ï¼šæ€§èƒ½è¦æ±‚æé«˜çš„äº¤äº’å¼åº”ç”¨
 * - ğŸ”„ LODç³»ç»Ÿï¼šè¿œè·ç¦»ç²’å­çš„å¿«é€Ÿè£å‰ª
 *
 * ã€æ€§èƒ½ç‰¹ç‚¹ã€‘ï¼š
 * - âœ… æ— çŸ©é˜µè¿ç®—ï¼šè·³è¿‡åæ ‡å˜æ¢
 * - âœ… çº¯å‘é‡æ“ä½œï¼šGPUå‘é‡å•å…ƒå‹å¥½
 * - âœ… åˆ†æ”¯æœ€å°‘ï¼šå‡å°‘GPUçº¿ç¨‹åˆ†åŒ–
 * - âœ… å†…å­˜é«˜æ•ˆï¼šå¤ç”¨é¢„è®¡ç®—ç»“æœ
 *
 * @param canonicalRayOrigin              æ ‡å‡†åŒ–ç©ºé—´ä¸­çš„å°„çº¿èµ·ç‚¹
 * @param canonicalUnormalizedRayDirection æ ‡å‡†åŒ–ç©ºé—´ä¸­çš„å°„çº¿æ–¹å‘ (æœªå½’ä¸€åŒ–)
 * @param minHitDistance                  æœ€å°æœ‰æ•ˆå‡»ä¸­è·ç¦»
 * @param maxHitDistance                  æœ€å¤§æœ‰æ•ˆå‡»ä¸­è·ç¦»
 * @param maxParticleSquaredDistance      æœ€å¤§ç²’å­å¹³æ–¹è·ç¦»é˜ˆå€¼
 * @param hitDistance                     è¾“å‡ºï¼šå‡»ä¸­è·ç¦»å‚æ•°tå€¼
 * @return æ˜¯å¦é€šè¿‡æ‰€æœ‰è·ç¦»å’Œå‡ ä½•æµ‹è¯•
 */
[CudaDeviceExport]
bool particleDensityHitInstance(
    float3 canonicalRayOrigin,
    float3 canonicalUnormalizedRayDirection,
    float minHitDistance,
    float maxHitDistance,
    float maxParticleSquaredDistance,
    out float hitDistance
)
{
    // ========== è¶…é«˜é€Ÿå®ä¾‹åŒ–æ£€æµ‹ï¼šçº¯æ•°å­¦å‡ ä½•è®¡ç®— ==========
    //
    // ã€è®¾è®¡å“²å­¦ã€‘ï¼š
    // è¿™æ˜¯æœ€ç²¾ç®€çš„ç¢°æ’æ£€æµ‹å®ç°ï¼Œä¸“ä¸ºæµ·é‡å¹¶è¡Œå¤„ç†ä¼˜åŒ–ã€‚
    // æ‰€æœ‰å¤æ‚çš„åæ ‡å˜æ¢éƒ½å·²é¢„å…ˆå®Œæˆï¼Œè¿™é‡Œåªåšçº¯æ•°å­¦è®¡ç®—ã€‚
    //
    
    // æ­¥éª¤1: ğŸ§® å°„çº¿åˆ°åŸç‚¹æœ€è¿‘ç‚¹çš„å‚æ•°tè®¡ç®—
    // æ•°å­¦æ¨å¯¼ï¼šæœ€å°åŒ– |canonicalRayOrigin + t * canonicalUnormalizedRayDirection|Â²
    // å¯¹tæ±‚å¯¼å¹¶ä»¤å…¶ä¸º0: d/dt[...] = 0 
    // è§£å¾—: t = -(origin Â· direction) / |direction|Â²
    //
    const float numerator = -dot(canonicalRayOrigin, canonicalUnormalizedRayDirection);
    //    ^^^^^^^^^^^^^
    //    åˆ†å­: -(å°„çº¿èµ·ç‚¹ Â· å°„çº¿æ–¹å‘) 
    //    ç‰©ç†æ„ä¹‰ï¼šèµ·ç‚¹å‘é‡åœ¨æ–¹å‘å‘é‡ä¸Šçš„æŠ•å½±(å–è´Ÿå·)
    
    const float denominator = rcp(dot(canonicalUnormalizedRayDirection, canonicalUnormalizedRayDirection));
    //    ^^^^^^^^^^^^^^^^^^^^^
    //    åˆ†æ¯å€’æ•°: 1 / |å°„çº¿æ–¹å‘|Â²
    //    rcp()æ˜¯GPUä¼˜åŒ–çš„å€’æ•°å‡½æ•°ï¼Œæ¯” (1.0/x) æ›´å¿«
    
    hitDistance = numerator * denominator;
    //    ^^^^^^^^^^^^
    //    æœ€ç»ˆç»“æœï¼šå°„çº¿å‚æ•°tï¼Œè¡¨ç¤ºæœ€è¿‘ç‚¹ä½ç½®
    //    å‡ ä½•æ„ä¹‰ï¼šorigin + t * direction = ç¦»åŸç‚¹æœ€è¿‘çš„å°„çº¿ä¸Šçš„ç‚¹

    // æ­¥éª¤2: âœ… ä¸‰é‡å®‰å…¨éªŒè¯
    // ç¡®ä¿è®¡ç®—å‡ºçš„å‡»ä¸­è·ç¦»æ»¡è¶³æ‰€æœ‰çº¦æŸæ¡ä»¶
    return (hitDistance > minHitDistance) &&              // éªŒè¯1: è¿‘è£å‰ªé¢æ£€æŸ¥
           (hitDistance < maxHitDistance) &&              // éªŒè¯2: è¿œè£å‰ªé¢æ£€æŸ¥
           (gaussianParticle.canonicalRayMinSquaredDistance(    // éªŒè¯3: å‡ ä½•ç›¸äº¤æ£€æŸ¥
                canonicalRayOrigin,                       //   ä½¿ç”¨æ ‡å‡†åŒ–å°„çº¿èµ·ç‚¹
                normalize(canonicalUnormalizedRayDirection)    //   å½’ä¸€åŒ–å°„çº¿æ–¹å‘
           ) < maxParticleSquaredDistance);
    //
    // ã€æ€§èƒ½è¦ç‚¹ã€‘ï¼š
    // 1. ğŸš€ æ— çŸ©é˜µè¿ç®—ï¼šé¿å…äº†æ˜‚è´µçš„åæ ‡å˜æ¢
    // 2. ğŸ¯ å‘é‡è®¡ç®—ï¼šå……åˆ†åˆ©ç”¨GPU SIMDæŒ‡ä»¤
    // 3. ğŸ“ æ•°å­¦ä¼˜åŒ–ï¼šä½¿ç”¨rcp()ç­‰GPUç‰¹åŒ–å‡½æ•°
    // 4. ğŸ”§ æœ€å°åˆ†æ”¯ï¼šå‡å°‘GPUçº¿ç¨‹å‘æ•£
    //
    // ã€ä½¿ç”¨åœºæ™¯ã€‘ï¼š
    // - å®ä¾‹åŒ–æ¸²æŸ“ï¼šç›¸åŒå‡ ä½•çš„å¤§è§„æ¨¡å¤åˆ¶
    // - LODä¼˜åŒ–ï¼šè¿œè·ç¦»ç²’å­çš„å¿«é€Ÿå‰”é™¤
    // - é¢„ç­›é€‰ï¼šåœ¨å®Œæ•´æ¸²æŸ“å‰çš„ç²—ç­›é€‰é˜¶æ®µ
}

/**
 * è®¡ç®—ç²’å­çš„å…¥å°„å…‰çº¿æ–¹å‘
 * 
 * æ ¹æ®å…‰æºä½ç½®å’Œç²’å­ä½ç½®ï¼Œè®¡ç®—å…¥å°„å…‰çº¿çš„æ–¹å‘ã€‚
 * ç”¨äºå…‰ç…§è®¡ç®—å’Œé˜´å½±æ•ˆæœã€‚
 * 
 * @param parameters ç²’å­å‚æ•°ï¼ˆåŒ…å«ä½ç½®ä¿¡æ¯ï¼‰
 * @param sourcePosition å…‰æºä½ç½®ï¼ˆä¸–ç•Œç©ºé—´ï¼‰
 * @return ä»å…‰æºåˆ°ç²’å­çš„å•ä½æ–¹å‘å‘é‡
 */
[CudaDeviceExport] float3 particleDensityIncidentDirection(
    in gaussianParticle.Parameters parameters,
    in float3 sourcePosition
)
{
    return gaussianParticle.incidentDirectionFromParameters(parameters, sourcePosition);
}

/**
 * å°†å…¥å°„æ–¹å‘æ¢¯åº¦åå‘ä¼ æ’­åˆ°ç¼“å†²åŒº
 * 
 * å¯¹å…¥å°„æ–¹å‘è®¡ç®—è¿›è¡Œåå‘å¾®åˆ†ï¼Œå°†æ¢¯åº¦ä¼ æ’­åˆ°ç²’å­ä½ç½®å‚æ•°ã€‚
 * ç”¨äºè®­ç»ƒé˜¶æ®µçš„å‚æ•°ä¼˜åŒ–ã€‚
 * 
 * @param particleIdx ç²’å­ç´¢å¼•
 * @param commonParameters é€šç”¨å‚æ•°
 * @param sourcePosition å…‰æºä½ç½®
 */
[CudaDeviceExport] void particleDensityIncidentDirectionBwdToBuffer(
    in uint32_t particleIdx,
    gaussianParticle.CommonParameters commonParameters,
    in float3 sourcePosition
)
{
    bwd_diff(gaussianParticle.incidentDirectionFromBuffer)(
        particleIdx, 
        commonParameters.parametersBuffer, 
        sourcePosition
    );
}
